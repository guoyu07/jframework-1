<!DOCTYPE html>

<html>
<head>
  <title>models.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="autodict.html">
                  autodict.coffee
                </a>
              
                
                <a class="source" href="autolist.html">
                  autolist.coffee
                </a>
              
                
                <a class="source" href="autovar.html">
                  autovar.coffee
                </a>
              
                
                <a class="source" href="components.html">
                  components.coffee
                </a>
              
                
                <a class="source" href="AreYouSure.html">
                  AreYouSure.coffee
                </a>
              
                
                <a class="source" href="Button.html">
                  Button.coffee
                </a>
              
                
                <a class="source" href="CancelButton.html">
                  CancelButton.coffee
                </a>
              
                
                <a class="source" href="DeleteButton.html">
                  DeleteButton.coffee
                </a>
              
                
                <a class="source" href="Dropdown.html">
                  Dropdown.coffee
                </a>
              
                
                <a class="source" href="EditButton.html">
                  EditButton.coffee
                </a>
              
                
                <a class="source" href="Expandable.html">
                  Expandable.coffee
                </a>
              
                
                <a class="source" href="KeyValueTable.html">
                  KeyValueTable.coffee
                </a>
              
                
                <a class="source" href="LinkButton.html">
                  LinkButton.coffee
                </a>
              
                
                <a class="source" href="Loader.html">
                  Loader.coffee
                </a>
              
                
                <a class="source" href="SubmitCancelDelete.html">
                  SubmitCancelDelete.coffee
                </a>
              
                
                <a class="source" href="TableRow.html">
                  TableRow.coffee
                </a>
              
                
                <a class="source" href="TextBox.html">
                  TextBox.coffee
                </a>
              
                
                <a class="source" href="denorm.html">
                  denorm.coffee
                </a>
              
                
                <a class="source" href="dict.html">
                  dict.coffee
                </a>
              
                
                <a class="source" href="dom.html">
                  dom.coffee
                </a>
              
                
                <a class="source" href="BooksDemo.html">
                  BooksDemo.coffee
                </a>
              
                
                <a class="source" href="SampleData.html">
                  SampleData.coffee
                </a>
              
                
                <a class="source" href="BatteryApi.html">
                  BatteryApi.coffee
                </a>
              
                
                <a class="source" href="ChatRoom.html">
                  ChatRoom.coffee
                </a>
              
                
                <a class="source" href="Home.html">
                  Home.coffee
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.coffee
                </a>
              
                
                <a class="source" href="NotFound.html">
                  NotFound.coffee
                </a>
              
                
                <a class="source" href="chat.html">
                  chat.coffee
                </a>
              
                
                <a class="source" href="routes.html">
                  routes.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="fetching.html">
                  fetching.coffee
                </a>
              
                
                <a class="source" href="j.html">
                  j.coffee
                </a>
              
                
                <a class="source" href="list.html">
                  list.coffee
                </a>
              
                
                <a class="source" href="models.html">
                  models.coffee
                </a>
              
                
                <a class="source" href="proptypes.html">
                  proptypes.coffee
                </a>
              
                
                <a class="source" href="publish.html">
                  publish.coffee
                </a>
              
                
                <a class="source" href="routing.html">
                  routing.coffee
                </a>
              
                
                <a class="source" href="autovar-tests.html">
                  autovar-tests.coffee
                </a>
              
                
                <a class="source" href="denorm-tests.html">
                  denorm-tests.coffee
                </a>
              
                
                <a class="source" href="dict-tests.html">
                  dict-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-client-tests.html">
                  jframework-client-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-tests.html">
                  jframework-tests.coffee
                </a>
              
                
                <a class="source" href="list-tests.html">
                  list-tests.coffee
                </a>
              
                
                <a class="source" href="publish-tests.html">
                  publish-tests.coffee
                </a>
              
                
                <a class="source" href="test-models.html">
                  test-models.coffee
                </a>
              
                
                <a class="source" href="util-tests.html">
                  util-tests.coffee
                </a>
              
                
                <a class="source" href="tracker.html">
                  tracker.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="var.html">
                  var.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>models.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015, Quixey Inc.
All rights reserved.
Licensed under the Modified BSD License found in the
LICENSE file in the root directory of this source tree.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>FIXME:</p>
<ol>
<li>If modelInstance has some fetched fields but modelInstance.a isn’t one of them,
then calling modelInstance.a() should register a dependency on a query for that
field. Right now it just throws VALUE_NOT_READY and never does anything about it.</li>
</ol>
<p>TODO:</p>
<ol>
<li>Let fieldSpecs have default values for fields, applicable when using “new”</li>
<li>A special method like modelInstance.isValid() to prevent inserting/updating an
invalid model</li>
<li>Type system with support for nested data structure schemas</li>
<li>Server-side read/write security specs</li>
<li>The field selector in a query should let you select names of reactives too,
and make the server compute their value</li>
<li>The field selector in a query should be more like GraphQL, so you can make the
server follow foreign keys for you without making an extra round trip.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">J</span>.<span class="hljs-title">Model</span></span>
    <span class="hljs-property">@_getEscapedSubdoc</span> = <span class="hljs-function"><span class="hljs-params">(subDoc)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> J.util.isPlainObject subDoc
            ret = {}
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> subDoc
                ret[<span class="hljs-property">@escapeDot</span> key] = <span class="hljs-property">@_getEscapedSubdoc</span> value
            ret
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> _.isArray subDoc
            <span class="hljs-property">@_getEscapedSubdoc</span> x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> subDoc
        <span class="hljs-keyword">else</span>
            subDoc


    <span class="hljs-property">@_getUnescapedSubdoc</span> = <span class="hljs-function"><span class="hljs-params">(subDoc)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> J.util.isPlainObject subDoc
            ret = {}
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> subDoc
                ret[<span class="hljs-property">@unescapeDot</span> key] = <span class="hljs-property">@_getUnescapedSubdoc</span> value
            ret
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> _.isArray subDoc
            <span class="hljs-property">@_getUnescapedSubdoc</span> x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> subDoc
        <span class="hljs-keyword">else</span>
            subDoc</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="-escapedot">@escapeDot</h2>
<hr>
<p>Specifically escape <code>.</code> and <code>$</code> in a string by
replacing them with <code>*DOT*</code> and <code>*DOLLAR*</code> respectively.</p>
<pre><code>J.Model.escapeDot(<span class="hljs-string">'func://www.example.com/func'</span>)
<span class="hljs-comment"># "func://www*DOT*example*DOT*.com/func"</span>
</code></pre><hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@escapeDot</span> = <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
        key.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'*DOT*'</span>).replace(<span class="hljs-regexp">/\$/g</span>, <span class="hljs-string">'*DOLLAR*'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="-fromjsonvalue">@fromJSONValue</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@fromJSONValue</span>: <span class="hljs-function"><span class="hljs-params">(jsonValue)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>jsonValue is <em>not</em> of the form {$type: ThisModelName, $value: someValue}.
It’s just the someValue part.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">unless</span> J.util.isPlainObject jsonValue
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">'Must override J.Model.fromJSONValue to decode non-object values'</span>

        <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> jsonValue
            <span class="hljs-keyword">if</span> fieldName[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'$'</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Bad jsonValue for <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>: <span class="hljs-subst">#{jsonValue}</span>"</span>

        <span class="hljs-property">@fromDoc</span> jsonValue</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="-fromdoc">@fromDoc</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@fromDoc</span>: <span class="hljs-function"><span class="hljs-params">(doc)</span> -&gt;</span>
        fields = EJSON.fromJSONValue <span class="hljs-property">@_getUnescapedSubdoc</span> doc

        <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">of</span> <span class="hljs-property">@fieldSpecs</span>
            <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> fields
                fields[fieldName] = J.makeValueNotReadyObject()

        <span class="hljs-keyword">new</span> @ fields</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-tosubdoc">@toSubdoc</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@toSubdoc</span>: <span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span>
<span class="hljs-function">        <span class="hljs-title">helper</span> = <span class="hljs-params">(value)</span> =&gt;</span>
            <span class="hljs-keyword">if</span> value <span class="hljs-keyword">instanceof</span> J.Dict
                helper value.getFields()
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">instanceof</span> J.List
                helper value.getValues()
            <span class="hljs-keyword">if</span> _.isArray(value)
                (helper v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> value)
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> J.util.isPlainObject(value)
                ret = {}
                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> value
                    ret[<span class="hljs-property">@escapeDot</span> k] = helper v
                ret
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">instanceof</span> J.Model
                value.toDoc()
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
                _.isNumber(value) <span class="hljs-keyword">or</span> _.isBoolean(value) <span class="hljs-keyword">or</span> _.isString(value) <span class="hljs-keyword">or</span>
                    value <span class="hljs-keyword">instanceof</span> Date <span class="hljs-keyword">or</span> value <span class="hljs-keyword">instanceof</span> RegExp <span class="hljs-keyword">or</span>
                    value <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
            )
                value
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Unsupported value type: <span class="hljs-subst">#{value}</span>"</span>

        helper x</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="-unescapedot">@unescapeDot</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@unescapeDot</span> = <span class="hljs-function"><span class="hljs-params">(key)</span> =&gt;</span>
        key.replace(<span class="hljs-regexp">/\*DOT\*/g</span>, <span class="hljs-string">'.'</span>).replace(<span class="hljs-regexp">/\*DOLLAR\*/g</span>, <span class="hljs-string">'$'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="clone">clone</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">clone</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Nonreactive because the clone’s fields are
their own new piece of application state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        doc = Tracker.nonreactive =&gt; <span class="hljs-property">@toDoc</span>()

        <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">in</span> _.keys doc
            <span class="hljs-keyword">if</span> doc[fieldName] <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                <span class="hljs-keyword">delete</span> doc[fieldName]

        instance = <span class="hljs-property">@modelClass</span>.fromDoc doc
        instance.collection = <span class="hljs-property">@collection</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Note that clones are always detached, alive, and not read-only</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        instance</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="get">get</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">get</span>: <span class="hljs-function"><span class="hljs-params">(fieldOrReactiveName)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> #<span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span> from collection <span class="hljs-subst">#{<span class="hljs-property">@collection</span>}</span> is dead"</span>

        isReactive = fieldOrReactiveName <span class="hljs-keyword">of</span> <span class="hljs-property">@modelClass</span>.reactiveSpecs

        <span class="hljs-keyword">if</span> isReactive
            reactiveName = fieldOrReactiveName
            reactiveSpec = <span class="hljs-property">@modelClass</span>.reactiveSpecs[fieldOrReactiveName]

            <span class="hljs-keyword">if</span> Meteor.isServer
                J.Var(reactiveSpec.val.call @).get()

            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> reactiveSpec.denorm <span class="hljs-keyword">and</span> <span class="hljs-property">@attached</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Record that the current computation uses this denormed reactive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    projection = <span class="hljs-attribute">_</span>: <span class="hljs-literal">false</span>
                    projection[reactiveName] = <span class="hljs-literal">true</span>
                    <span class="hljs-keyword">if</span> Tracker.active</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>We might be temporarily bumming this field off some other cursor owned
by some other computation, so we need to run fetchOne to update
J.fetching._requestersByQs and make sure the field data doesn’t get
pulled away.
While we do want to stop watching this field when the current computation
invalidates, we might <em>not</em> need to invalidate the current computation when
the new field data arrives. The reactivity is handled by the @_reactives dict.
Therefore a child J.AutoVar is the perfect place to do the bookkeeping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        J.AutoVar(
                            <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> <span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span>&gt;.reactiveFetcher.<span class="hljs-subst">#{fieldOrReactiveName}</span>"</span>
                            =&gt;
                                <span class="hljs-property">@modelClass</span>.fetchOne <span class="hljs-property">@_id</span>,
                                    <span class="hljs-attribute">fields</span>: projection
                            <span class="hljs-literal">true</span>
                        )

                    <span class="hljs-property">@_reactives</span>.get reactiveName

                <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Denormed reactives behave like non-denormed reactives on
unattached instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-property">@reactives</span>[reactiveName].get()

        <span class="hljs-keyword">else</span>
            fieldName = fieldOrReactiveName

            <span class="hljs-keyword">if</span> Tracker.active
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_fields</span>.hasKey(fieldName) <span class="hljs-keyword">and</span> <span class="hljs-property">@_fields</span>.tryGet(fieldName) <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                    <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> <span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span>&gt;.<span class="hljs-subst">#{fieldName}</span>() is undefined"</span>
                    <span class="hljs-built_in">console</span>.groupCollapsed()
                    <span class="hljs-built_in">console</span>.trace()
                    <span class="hljs-built_in">console</span>.groupEnd()

                <span class="hljs-keyword">if</span> <span class="hljs-property">@attached</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Record that the current computation uses the current field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    projection = <span class="hljs-attribute">_</span>: <span class="hljs-literal">false</span>
                    projection[fieldName] = <span class="hljs-literal">true</span>
                    <span class="hljs-keyword">if</span> Tracker.active</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>See the comment for the J.AutoVar in the above if-branch. In this case,
the reactivity for the caller computation is handled by the @_fields dict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        J.AutoVar(
                            <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> <span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span>&gt;.fieldFetcher.<span class="hljs-subst">#{fieldOrReactiveName}</span>"</span>
                            =&gt;
                                <span class="hljs-property">@modelClass</span>.fetchOne <span class="hljs-property">@_id</span>,
                                    <span class="hljs-attribute">fields</span>: projection
                            <span class="hljs-literal">true</span>
                        )

            <span class="hljs-property">@_fields</span>.forceGet fieldName</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="insert">insert</h2>
<hr>
<p>Insert a model document into a collection.</p>
<pre><code>model.insert(collection, callback)
model.insert(callback)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">insert</span>: <span class="hljs-function"><span class="hljs-params">(collection = <span class="hljs-property">@collection</span>, callback)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> _.isFunction(collection) <span class="hljs-keyword">and</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
            callback = collection
            collection = <span class="hljs-property">@collection</span>

        <span class="hljs-keyword">unless</span> collection <span class="hljs-keyword">instanceof</span> Mongo.Collection
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid collection to <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>.insert"</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@attached</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@collection</span> <span class="hljs-keyword">is</span> collection
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't insert <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance into its own attached collection"</span>

        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't insert dead <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance"</span>

        doc = Tracker.nonreactive =&gt; <span class="hljs-property">@toDoc</span>()
        J.assert J.util.isPlainObject doc
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> doc._id?</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>The Mongo driver will give us an ID but we
can’t pass it a null ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">delete</span> doc._id</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Returns @_id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_id</span> = collection.insert doc, callback</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="remove">remove</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">remove</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't remove dead <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance."</span>

        Meteor.call <span class="hljs-string">'_jRemove'</span>, <span class="hljs-property">@modelClass</span>.name, <span class="hljs-property">@_id</span>, callback</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="save">save</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">save</span>: <span class="hljs-function"><span class="hljs-params">(collection = <span class="hljs-property">@collection</span>, callback)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> _.isFunction(collection) <span class="hljs-keyword">and</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Can call save(callback) to use @collection
as the collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            callback = collection
            collection = <span class="hljs-property">@collection</span>

        <span class="hljs-keyword">unless</span> collection <span class="hljs-keyword">instanceof</span> Mongo.Collection
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid collection to <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>.insert"</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@attached</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@collection</span> <span class="hljs-keyword">is</span> collection
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't save <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance into its own attached collection"</span>

        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't save dead <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance"</span>

        doc = Tracker.nonreactive =&gt; <span class="hljs-property">@toDoc</span>()

        doc._id ?= Random.hexString(<span class="hljs-number">10</span>)

        Meteor.call <span class="hljs-string">'_jSave'</span>, <span class="hljs-property">@modelClass</span>.name, doc, callback</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Returns @_id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_id</span> ?= doc._id</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="set">set</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(fields)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> J.util.isPlainObject fields
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid fields setter: <span class="hljs-subst">#{fields}</span>"</span>

        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> #<span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span> from collection <span class="hljs-subst">#{<span class="hljs-property">@collection</span>}</span> is dead"</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@attached</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't set <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> #<span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span> because it is attached
                to collection <span class="hljs-subst">#{J.util.stringify <span class="hljs-property">@collection</span>._name}</span>"</span>

        <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> fields
            <span class="hljs-property">@_fields</span>.set fieldName, J.Var.wrap value, <span class="hljs-literal">true</span>
        <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="todoc">toDoc</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toDoc</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Reactive.
Returns an EJSON object with all the
user-defined types serialized into JSON, but
not the EJSON primitives (Date and Binary).
(A “compound EJSON object” can contain user-defined
types in the form of J.Model instances.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't call toDoc on dead <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance"</span>

        doc = J.Model.toSubdoc <span class="hljs-property">@_fields</span>.tryToObj()

        <span class="hljs-keyword">if</span> <span class="hljs-property">@modelClass</span>.idSpec <span class="hljs-keyword">is</span> J.PropTypes.key
            keyReady = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">try</span>
                key = <span class="hljs-property">@key</span>()
                keyReady = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">catch</span> e
                <span class="hljs-keyword">if</span> e <span class="hljs-keyword">not</span> <span class="hljs-keyword">instanceof</span> J.VALUE_NOT_READY
                    <span class="hljs-built_in">console</span>.error e.stack
                    <span class="hljs-keyword">throw</span> e

            <span class="hljs-keyword">if</span> keyReady
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key?
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>&gt;.key() returned <span class="hljs-subst">#{key}</span>"</span>
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_id</span>? <span class="hljs-keyword">and</span> key <span class="hljs-keyword">isnt</span> <span class="hljs-property">@_id</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>&gt;.key() returned <span class="hljs-subst">#{key}</span>
                        but has _id <span class="hljs-subst">#{JSON.stringify <span class="hljs-property">@_id</span>}</span>"</span>

                doc._id = key

            <span class="hljs-keyword">else</span>
                doc._id = <span class="hljs-property">@_id</span> <span class="hljs-comment"># may be null</span>

        <span class="hljs-keyword">else</span>
            doc._id = <span class="hljs-property">@_id</span> <span class="hljs-comment"># may be null</span>

        doc</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="tojsonvalue">toJSONValue</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toJSONValue</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Used by Meteor EJSON, e.g. EJSON.stringify.
Note that the name is misleading because
EJSON’s special primitives (Date and Binary)
aren’t returned as JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-property">@toDoc</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="tostring">toString</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toString</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@alive</span>
            Tracker.nonreactive =&gt; EJSON.stringify @
        <span class="hljs-keyword">else</span>
            <span class="hljs-string">"&lt;<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> #<span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span> DEAD&gt;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="tryget">tryGet</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">tryGet</span>: <span class="hljs-function"><span class="hljs-params">(key, defaultValue)</span> -&gt;</span>
        J.tryGet(
            <span class="hljs-function">=&gt;</span> <span class="hljs-property">@get</span> key
            defaultValue
        )</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2 id="typename">typeName</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">typeName</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Used by Meteor EJSON</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@modelClass</span>.name</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h2 id="update">update</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> <span class="hljs-property">@alive</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't call update on dead <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span> instance"</span>

        <span class="hljs-keyword">unless</span> J.util.isPlainObject(args[<span class="hljs-number">0</span>]) <span class="hljs-keyword">and</span> _.all(key[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'$'</span> <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> args[<span class="hljs-number">0</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Calling something like .update(foo: bar) would replace the entire
Mongo doc, which is basically always a mistake. We almost always
want to call something like .update($set: foo: bar) instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Must use a $ operation for <span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>.update"</span>

        <span class="hljs-property">@collection</span>.update.bind(<span class="hljs-property">@collection</span>, <span class="hljs-property">@_id</span>).apply <span class="hljs-literal">null</span>, args



J.m = J.models = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Queue up all model definitions to help the J
framework startup sequence. E.g. all models
must be defined before all components.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>modelDefinitionQueue = []</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="j-definemodel-j-dm-">J.defineModel (J.dm)</h2>
<hr>
<p>TODO: write documentation</p>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>J.dm = J.defineModel = <span class="hljs-function"><span class="hljs-params">(modelName, collectionName, members = {}, staticMembers = {})</span> -&gt;</span>
    modelDefinitionQueue.push
        <span class="hljs-attribute">modelName</span>: modelName
        <span class="hljs-attribute">collectionName</span>: collectionName
        <span class="hljs-attribute">members</span>: members,
        <span class="hljs-attribute">staticMembers</span>: staticMembers


J._defineModel = <span class="hljs-function"><span class="hljs-params">(modelName, collectionName, members = {}, staticMembers = {})</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">modelConstructor</span> = <span class="hljs-params">(initFields = {}, <span class="hljs-property">@collection</span> = <span class="hljs-property">@modelClass</span>.collection)</span> -&gt;</span>
        <span class="hljs-property">@_id</span> = initFields._id ? <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>@collection is the collection that was queried
to obtain this instance, or the original attached
clone-ancestor of this instance, or just the
default place we’re going to be inserting/saving to.</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If true, this instance reactively receives
changes from its collection and is immutable
to the application layer.
Note that an attached instance always has an _id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@attached</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Attached instances die when the collection
they came from no longer contains their ID.
They never come back to life, but a new
attached instance with the same ID may
eventually replace them in the collection.
Detached instances dies when their creator
computation dies, if there is one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@alive</span> = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> Tracker.active <span class="hljs-keyword">then</span> Tracker.onInvalidate =&gt;
            <span class="hljs-property">@alive</span> = <span class="hljs-literal">false</span>

        nonIdInitFields = _.clone initFields
        <span class="hljs-keyword">delete</span> nonIdInitFields._id

        <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> nonIdInitFields
            <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> <span class="hljs-property">@modelClass</span>.fieldSpecs
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid field <span class="hljs-subst">#{JSON.stringify fieldName}</span> passed
                    to <span class="hljs-subst">#{modelClass.name}</span> constructor"</span>

        <span class="hljs-property">@_fields</span> = J.Dict()

        <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> nonIdInitFields
            <span class="hljs-property">@_fields</span>.setOrAdd fieldName, J.Var.wrap value, <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@_id</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@modelClass</span>.idSpec <span class="hljs-keyword">is</span> J.PropTypes.key</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>The fields not specified in the constructor argument should be initialized
to the class’s default values, but for purposes of checking consistency
with the key idSpec, they should be not-ready.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">of</span> <span class="hljs-property">@modelClass</span>.fieldSpecs
                <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> nonIdInitFields
                    <span class="hljs-property">@_fields</span>.setOrAdd fieldName, J.makeValueNotReadyObject()

            keyReady = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">try</span>
                key = Tracker.nonreactive =&gt; <span class="hljs-property">@key</span>()
                keyReady = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">catch</span> e
                <span class="hljs-keyword">if</span> e <span class="hljs-keyword">not</span> <span class="hljs-keyword">instanceof</span> J.VALUE_NOT_READY
                    <span class="hljs-built_in">console</span>.error e.stack
                    <span class="hljs-keyword">throw</span> e

            <span class="hljs-keyword">if</span> keyReady <span class="hljs-keyword">and</span> <span class="hljs-property">@_id</span> <span class="hljs-keyword">isnt</span> key
                <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@modelClass</span>.name}</span>._id is <span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span> but key() is <span class="hljs-subst">#{key}</span>"</span>

        <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">of</span> <span class="hljs-property">@modelClass</span>.fieldSpecs
            <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> nonIdInitFields
                <span class="hljs-property">@_fields</span>.setOrAdd fieldName, <span class="hljs-literal">null</span> <span class="hljs-comment"># <span class="hljs-doctag"><span class="hljs-keyword">TODO</span></span>: Support default values for fields of new model instances</span>

        <span class="hljs-property">@reactives</span> = {} <span class="hljs-comment"># reactiveName: autoVar</span>
        <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> <span class="hljs-property">@modelClass</span>.reactiveSpecs
            <span class="hljs-property">@reactives</span>[reactiveName] = <span class="hljs-keyword">do</span> (reactiveName, reactiveSpec) =&gt;
                J.AutoVar <span class="hljs-string">"&lt;<span class="hljs-subst">#{modelName}</span> #<span class="hljs-subst">#{<span class="hljs-property">@_id</span>}</span>&gt;.!<span class="hljs-subst">#{reactiveName}</span>"</span>,
                    <span class="hljs-function">=&gt;</span> reactiveSpec.val.call @

        <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Hack to set up the read-only Function.name value
for the class. Having the right Function.name is useful
for console debugging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    eval <span class="hljs-string">"""
        function <span class="hljs-subst">#{modelName}</span>() {
            return modelConstructor.apply(this, arguments);
        };
        var modelClass = <span class="hljs-subst">#{modelName}</span>;
    """</span>

    _.extend modelClass, J.Model
    _.extend modelClass, staticMembers
    modelClass.collection = <span class="hljs-literal">null</span>

    memberSpecs = _.clone members
    modelClass.idSpec = memberSpecs._id
    <span class="hljs-keyword">delete</span> memberSpecs._id
    modelClass.fieldSpecs = memberSpecs.fields ? {}
    <span class="hljs-keyword">delete</span> memberSpecs.fields
    modelClass.reactiveSpecs = memberSpecs.reactives ? {}
    <span class="hljs-keyword">delete</span> memberSpecs.reactives
    modelClass.indexSpecs = memberSpecs.indexes ? []
    <span class="hljs-keyword">delete</span> memberSpecs.indexes

    modelClass.prototype = <span class="hljs-keyword">new</span> J.Model()
    _.extend modelClass.prototype, memberSpecs
    modelClass.prototype.modelClass = modelClass

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{modelName}</span> missing _id spec"</span> <span class="hljs-keyword">unless</span> modelClass.idSpec?

    fieldAndReactiveSet = {} <span class="hljs-comment"># fieldOrReactiveName: true</span>
    <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">of</span> modelClass.fieldSpecs
        <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">is</span> <span class="hljs-string">'_id'</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"_id is not a valid field name for <span class="hljs-subst">#{modelName}</span>"</span>

        fieldAndReactiveSet[fieldName] = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
        <span class="hljs-keyword">if</span> reactiveName <span class="hljs-keyword">of</span> fieldAndReactiveSet
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Can't have same name for <span class="hljs-subst">#{modelName}</span> field and reactive:
                <span class="hljs-subst">#{JSON.stringify reactiveName}</span>"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> reactiveSpec.val?
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{modelClass}</span>.reactives.<span class="hljs-subst">#{reactiveName}</span> missing val function"</span>

        fieldAndReactiveSet[reactiveName] = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Set up @[fieldOrReactiveName] methods for getting/setting fields and getting reactives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> fieldOrReactiveName <span class="hljs-keyword">of</span> fieldAndReactiveSet
        isReactive = fieldOrReactiveName <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
        spec = modelClass[<span class="hljs-keyword">if</span> isReactive <span class="hljs-keyword">then</span> <span class="hljs-string">'reactiveSpecs'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'fieldSpecs'</span>][fieldOrReactiveName]

        modelClass.prototype[fieldOrReactiveName] ?= <span class="hljs-keyword">do</span> (fieldOrReactiveName, isReactive, spec) -&gt; (value) -&gt;
            <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Getter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-property">@get</span> fieldOrReactiveName
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> isReactive
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Can't pass arguments to reactive: <span class="hljs-subst">#{modelClass}</span>.<span class="hljs-subst">#{fieldOrReactiveName}</span>"</span>
                setter = {}
                setter[fieldOrReactiveName] = value
                <span class="hljs-property">@set</span> setter</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Set up class methods for collection operations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> collectionName?
        <span class="hljs-keyword">if</span> Meteor.isClient</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The client has attached instances which power
a lot of fancy granular reactivity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            collection = <span class="hljs-keyword">new</span> Mongo.Collection collectionName,
                <span class="hljs-attribute">transform</span>: <span class="hljs-function"><span class="hljs-params">(doc)</span> -&gt;</span>
                    J.assert doc._id <span class="hljs-keyword">of</span> collection._attachedInstances
                    collection._attachedInstances[doc._id]

            collection._attachedInstances = {} <span class="hljs-comment"># _id: instance</span>

            collection.find().observeChanges
                <span class="hljs-attribute">added</span>: <span class="hljs-function"><span class="hljs-params">(id, fields)</span> -&gt;</span>
                    doc = _.clone fields
                    doc._id = id

                    reactivesObj = doc._reactives
                    <span class="hljs-keyword">delete</span> doc._reactives

                    instance = modelClass.fromDoc doc
                    instance.collection = collection
                    instance.attached = <span class="hljs-literal">true</span>

                    instance._fields.setReadOnly <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The @_reactives dict stores the published values of reactives
with denorm:true (i.e. server handles all their reactivity).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    instance._reactives = J.Dict() <span class="hljs-comment"># denormedReactiveName: value</span>
                    <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
                        <span class="hljs-keyword">if</span> reactiveSpec.denorm
                            instance._reactives.setOrAdd reactiveName, J.makeValueNotReadyObject()

                    <span class="hljs-keyword">if</span> reactivesObj?
                        reactivesSetter = {}

                        <span class="hljs-keyword">for</span> reactiveName, reactiveObj <span class="hljs-keyword">of</span> reactivesObj
                            reactivesSetter[reactiveName] = modelClass._getUnescapedSubdoc reactiveObj.val
                            <span class="hljs-keyword">if</span> reactivesSetter[reactiveName] <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                                reactivesSetter[reactiveName] = J.makeValueNotReadyObject()

                        instance._reactives.set reactivesSetter

                    collection._attachedInstances[id] = instance

                <span class="hljs-attribute">changed</span>: <span class="hljs-function"><span class="hljs-params">(id, fields)</span> -&gt;</span>
                    fields = _.clone fields

                    instance = collection._attachedInstances[id]

                    reactivesObj = fields._reactives
                    <span class="hljs-keyword">delete</span> fields._reactives

                    fieldsSetter = modelClass._getUnescapedSubdoc fields
                    <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> fieldsSetter
                        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                            fieldsSetter[fieldName] = J.makeValueNotReadyObject()
                    instance._fields._forceSet fieldsSetter

                    <span class="hljs-keyword">if</span> reactivesObj?
                        reactivesSetter = {}

                        <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
                            <span class="hljs-keyword">if</span> reactiveSpec.denorm
                                <span class="hljs-keyword">if</span> reactiveName <span class="hljs-keyword">of</span> reactivesObj
                                    reactivesSetter[reactiveName] =
                                        modelClass._getUnescapedSubdoc reactivesObj[reactiveName].val
                                <span class="hljs-keyword">if</span> reactivesSetter[reactiveName] <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                                    reactivesSetter[reactiveName] = J.makeValueNotReadyObject()

                        instance._reactives._forceSet reactivesSetter

                <span class="hljs-attribute">removed</span>: <span class="hljs-function"><span class="hljs-params">(id)</span> -&gt;</span>
                    instance = collection._attachedInstances[id]
                    instance.alive = <span class="hljs-literal">false</span>
                    <span class="hljs-keyword">for</span> reactiveName, reactive <span class="hljs-keyword">of</span> instance.reactives
                        reactive.stop()
                    <span class="hljs-keyword">delete</span> collection._attachedInstances[id]

        <span class="hljs-keyword">if</span> Meteor.isServer</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>The server uses exclusively detached instances and
doesn’t make use of much reactivity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            collection = <span class="hljs-keyword">new</span> Mongo.Collection collectionName,
                <span class="hljs-attribute">transform</span>: <span class="hljs-function"><span class="hljs-params">(doc)</span> -&gt;</span>
                    doc = _.clone doc

                    reactivesObj = modelClass._getUnescapedSubdoc doc._reactives
                    <span class="hljs-keyword">if</span> reactivesObj?
                        <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"No reason for the server-side ORM to ever
                            fetch the _reactives field."</span>
                        <span class="hljs-built_in">console</span>.trace()
                    <span class="hljs-keyword">delete</span> doc._reactives

                    instance = modelClass.fromDoc doc
                    instance.collection = collection

                    instance

            <span class="hljs-keyword">for</span> indexSpec <span class="hljs-keyword">in</span> modelClass.indexSpecs
                indexFieldsSpec = _.clone indexSpec
                <span class="hljs-keyword">if</span> _.isObject indexSpec.options
                    <span class="hljs-keyword">delete</span> indexFieldsSpec.options
                    indexOptionsSpec = indexSpec.options
                <span class="hljs-keyword">else</span>
                    indexOptionsSpec = {}
                collection._ensureIndex indexFieldsSpec, indexOptionsSpec


        _.extend modelClass,
            <span class="hljs-attribute">collection</span>: collection,
            <span class="hljs-attribute">fetchDict</span>: <span class="hljs-function"><span class="hljs-params">(docIdsOrQuery)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> docIdsOrQuery <span class="hljs-keyword">instanceof</span> J.List <span class="hljs-keyword">or</span> _.isArray docIdsOrQuery
                    <span class="hljs-keyword">if</span> J.List.unwrap(docIdsOrQuery).length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
                        <span class="hljs-keyword">return</span> J.Dict()

                query =
                    <span class="hljs-keyword">if</span> docIdsOrQuery <span class="hljs-keyword">instanceof</span> J.List <span class="hljs-keyword">or</span> _.isArray docIdsOrQuery
                        <span class="hljs-attribute">_id</span>: <span class="hljs-attribute">$in</span>: docIdsOrQuery
                    <span class="hljs-keyword">else</span>
                        docIdsOrQuery
                instances = <span class="hljs-property">@fetch</span> query
                instanceById = J.Dict()
                instances.forEach (instance) -&gt;
                    instanceById.setOrAdd instance._id, instance
                instanceById

            <span class="hljs-attribute">fetchIds</span>: <span class="hljs-function"><span class="hljs-params">(docIds, includeHoles = <span class="hljs-literal">false</span>)</span> -&gt;</span>
                instanceDict = <span class="hljs-property">@fetchDict</span> docIds
                instanceList = J.List()
                <span class="hljs-keyword">for</span> docId <span class="hljs-keyword">in</span> J.List.unwrap docIds
                    <span class="hljs-keyword">if</span> instanceDict.get(docId)?
                        instanceList.push instanceDict.get(docId)
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> includeHoles
                        instanceList.push <span class="hljs-literal">null</span>
                instanceList

            <span class="hljs-attribute">fetch</span>: <span class="hljs-function"><span class="hljs-params">(selector = {}, options = {})</span> -&gt;</span>
                <span class="hljs-keyword">if</span> Meteor.isClient <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> Tracker.active
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"On the client, must call <span class="hljs-subst">#{modelName}</span>.fetch
                        from a reactive computation."</span>

                <span class="hljs-keyword">if</span> selector <span class="hljs-keyword">instanceof</span> J.Dict
                    selector = selector.toObj()
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> J.util.isPlainObject selector
                    selector = J.Dict(selector).toObj()
                options = J.Dict(options).toObj()

                querySpec =
                    <span class="hljs-attribute">modelName</span>: modelName
                    <span class="hljs-attribute">selector</span>: selector
                    <span class="hljs-attribute">fields</span>: options.fields
                    <span class="hljs-attribute">sort</span>: options.sort
                    <span class="hljs-attribute">skip</span>: options.skip
                    <span class="hljs-attribute">limit</span>: options.limit

                <span class="hljs-keyword">if</span> Meteor.isServer
                    qsString = J.fetching.stringifyQs querySpec

                    <span class="hljs-keyword">if</span> J._watchedQuerySpecSet.get()?
                        J._watchedQuerySpecSet.get()[qsString] = <span class="hljs-literal">true</span>

                    mongoFieldsArg = J.fetching.projectionToMongoFieldsArg @, options.fields ? {}

                    fieldNameSet = {}
                    <span class="hljs-keyword">for</span> fieldSpec <span class="hljs-keyword">in</span> _.keys mongoFieldsArg
                        fieldName = fieldSpec.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>]
                        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">is</span> <span class="hljs-string">'_id'</span>

                        <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">is</span> <span class="hljs-string">'_reactives'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Loading denormalized reactive values isn’t currently
supported on the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">delete</span> mongoFieldsArg[fieldSpec]
                        <span class="hljs-keyword">else</span>
                            fieldNameSet[fieldName] = <span class="hljs-literal">true</span>

                    mongoOptions = _.clone options
                    mongoOptions.fields = mongoFieldsArg

                    instances = J.List <span class="hljs-property">@find</span>(selector, mongoOptions).fetch()</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Treat fields that are missing in the Mongo doc (even
though they were included in the query) as having a
default value of null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">of</span> fieldNameSet
                        instances.forEach (instance) =&gt;
                            setter = {}
                            <span class="hljs-keyword">if</span> instance.tryGet(fieldName) <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                                setter[fieldName] = <span class="hljs-literal">null</span>
                            instance.set setter

                    <span class="hljs-keyword">return</span> instances

                J.fetching.requestQuery querySpec

            <span class="hljs-attribute">fetchOne</span>: <span class="hljs-function"><span class="hljs-params">(selector = {}, options = {})</span> -&gt;</span>
                <span class="hljs-keyword">if</span> selector <span class="hljs-keyword">instanceof</span> J.Dict
                    selector = selector.toObj()
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> J.util.isPlainObject selector
                    selector = J.Dict(selector).toObj()
                options = J.Dict(options).toObj()

                options = _.clone options
                options.limit = <span class="hljs-number">1</span>
                results = <span class="hljs-property">@fetch</span> selector, options
                <span class="hljs-keyword">if</span> results <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                    <span class="hljs-literal">undefined</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> results.size() <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Note that a normal Mongo cursor would
return undefined, but for us null means
“definitely doesn’t exist” while undefined
means “fetching in progress”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-literal">null</span>
                <span class="hljs-keyword">else</span>
                    results.get <span class="hljs-number">0</span>

            <span class="hljs-attribute">find</span>: collection.find.bind collection
            <span class="hljs-attribute">findOne</span>: collection.findOne.bind collection
            <span class="hljs-attribute">insert</span>: <span class="hljs-function"><span class="hljs-params">(instance, callback)</span> -&gt;</span>
                <span class="hljs-keyword">unless</span> instance <span class="hljs-keyword">instanceof</span> modelClass
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>.insert requires <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> instance."</span>
                instance.insert collection, callback

            <span class="hljs-attribute">update</span>: collection.update.bind collection
            <span class="hljs-attribute">upsert</span>: collection.upsert.bind collection
            <span class="hljs-attribute">remove</span>: collection.remove.bind collection
            <span class="hljs-attribute">tryFetch</span>: <span class="hljs-function"><span class="hljs-params">(selector = {}, options = {})</span> -&gt;</span>
                J.tryGet =&gt; <span class="hljs-property">@fetch</span> selector, options
            <span class="hljs-attribute">tryFetchOne</span>: <span class="hljs-function"><span class="hljs-params">(selector = {}, options = {})</span> -&gt;</span>
                J.tryGet =&gt; <span class="hljs-property">@fetchOne</span> selector, options


    J.models[modelName] = modelClass
    $$[modelName] = modelClass

    EJSON.addType modelName, modelClass.fromJSONValue.bind modelClass



Meteor.methods
    <span class="hljs-attribute">_jSave</span>: <span class="hljs-function"><span class="hljs-params">(modelName, doc)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>This also runs on the client as a stub</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        J.assert doc._id?
        modelClass = J.models[modelName]

        fields = _.clone doc
        <span class="hljs-keyword">delete</span> fields._id

        _reserved = modelName <span class="hljs-keyword">in</span> [<span class="hljs-string">'JDataSession'</span>]

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _reserved
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">'jSave'</span>, modelName, doc, <span class="hljs-property">@isSimulation</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>TODO: Validation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@isSimulation</span>
            modelClass.collection.upsert doc._id,
                <span class="hljs-attribute">$set</span>: fields
            <span class="hljs-keyword">return</span>

        oldDoc = modelClass.findOne(
            doc._id
        ,
            <span class="hljs-attribute">fields</span>:
                <span class="hljs-attribute">_reactives</span>: <span class="hljs-number">0</span>
            <span class="hljs-attribute">transform</span>: <span class="hljs-literal">false</span>
        )

        setter = {}
        newDoc = J.util.deepClone oldDoc ? {<span class="hljs-attribute">_id</span>: doc._id}
        <span class="hljs-keyword">for</span> fieldName, newValue <span class="hljs-keyword">of</span> fields
            <span class="hljs-keyword">if</span> newValue <span class="hljs-keyword">isnt</span> <span class="hljs-literal">undefined</span>
                setter[fieldName] = newValue
                newDoc[fieldName] = newValue

        modelClass.collection.upsert doc._id,
            <span class="hljs-attribute">$set</span>: setter

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _reserved
            J.denorm.resetWatchers modelName, doc._id, oldDoc ? {<span class="hljs-attribute">_id</span>: doc._id}, newDoc

        doc._id

    <span class="hljs-attribute">_jRemove</span>: <span class="hljs-function"><span class="hljs-params">(modelName, instanceId, oldDoc = <span class="hljs-literal">null</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>This also runs on the client as a stub</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        J.assert instanceId?
        modelClass = J.models[modelName]

        _reserved = modelName <span class="hljs-keyword">in</span> [<span class="hljs-string">'JDataSession'</span>]

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _reserved
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">'jRemove'</span>, modelName, instanceId, <span class="hljs-property">@isSimulation</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@isSimulation</span>
            modelClass.collection.remove instanceId
            <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> oldDoc?
            oldDoc = modelClass.findOne(
                instanceId
            ,
                <span class="hljs-attribute">fields</span>:
                    <span class="hljs-attribute">_reactives</span>: <span class="hljs-number">0</span>
                <span class="hljs-attribute">transform</span>: <span class="hljs-literal">false</span>
            )

        ret = modelClass.collection.remove instanceId

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _reserved
            J.denorm.resetWatchers modelName, instanceId, oldDoc, {}

        ret


Meteor.startup -&gt;
    <span class="hljs-keyword">for</span> modelDef <span class="hljs-keyword">in</span> modelDefinitionQueue
        J._defineModel modelDef.modelName, modelDef.collectionName, modelDef.members, modelDef.staticMembers

    modelDefinitionQueue = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span> Meteor.isServer
        J.denorm.ensureAllReactiveWatcherIndexes()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="http://fuelyourcoding.com/scripts/toc/js/jquery.tableofcontents.min.js"></script>
  <script>
    $(function () {
      $("h1").first().after("<ul id='toc'>").after("<hr>");
      $("#toc").after("<hr>").tableOfContents(null, {
        startLevel: 2,
        depth: 10
      });
    });
  </script>
</body>
</html>

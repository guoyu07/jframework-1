<!DOCTYPE html>

<html>
<head>
  <title>jframework-tests.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="autodict.html">
                  autodict.coffee
                </a>
              
                
                <a class="source" href="autolist.html">
                  autolist.coffee
                </a>
              
                
                <a class="source" href="autovar.html">
                  autovar.coffee
                </a>
              
                
                <a class="source" href="components.html">
                  components.coffee
                </a>
              
                
                <a class="source" href="AreYouSure.html">
                  AreYouSure.coffee
                </a>
              
                
                <a class="source" href="Button.html">
                  Button.coffee
                </a>
              
                
                <a class="source" href="CancelButton.html">
                  CancelButton.coffee
                </a>
              
                
                <a class="source" href="DeleteButton.html">
                  DeleteButton.coffee
                </a>
              
                
                <a class="source" href="Dropdown.html">
                  Dropdown.coffee
                </a>
              
                
                <a class="source" href="EditButton.html">
                  EditButton.coffee
                </a>
              
                
                <a class="source" href="Expandable.html">
                  Expandable.coffee
                </a>
              
                
                <a class="source" href="KeyValueTable.html">
                  KeyValueTable.coffee
                </a>
              
                
                <a class="source" href="LinkButton.html">
                  LinkButton.coffee
                </a>
              
                
                <a class="source" href="Loader.html">
                  Loader.coffee
                </a>
              
                
                <a class="source" href="SubmitCancelDelete.html">
                  SubmitCancelDelete.coffee
                </a>
              
                
                <a class="source" href="TableRow.html">
                  TableRow.coffee
                </a>
              
                
                <a class="source" href="TextBox.html">
                  TextBox.coffee
                </a>
              
                
                <a class="source" href="denorm.html">
                  denorm.coffee
                </a>
              
                
                <a class="source" href="dict.html">
                  dict.coffee
                </a>
              
                
                <a class="source" href="dom.html">
                  dom.coffee
                </a>
              
                
                <a class="source" href="BooksDemo.html">
                  BooksDemo.coffee
                </a>
              
                
                <a class="source" href="SampleData.html">
                  SampleData.coffee
                </a>
              
                
                <a class="source" href="BatteryApi.html">
                  BatteryApi.coffee
                </a>
              
                
                <a class="source" href="ChatRoom.html">
                  ChatRoom.coffee
                </a>
              
                
                <a class="source" href="Home.html">
                  Home.coffee
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.coffee
                </a>
              
                
                <a class="source" href="NotFound.html">
                  NotFound.coffee
                </a>
              
                
                <a class="source" href="chat.html">
                  chat.coffee
                </a>
              
                
                <a class="source" href="routes.html">
                  routes.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="fetching.html">
                  fetching.coffee
                </a>
              
                
                <a class="source" href="j.html">
                  j.coffee
                </a>
              
                
                <a class="source" href="list.html">
                  list.coffee
                </a>
              
                
                <a class="source" href="models.html">
                  models.coffee
                </a>
              
                
                <a class="source" href="proptypes.html">
                  proptypes.coffee
                </a>
              
                
                <a class="source" href="publish.html">
                  publish.coffee
                </a>
              
                
                <a class="source" href="routing.html">
                  routing.coffee
                </a>
              
                
                <a class="source" href="autovar-tests.html">
                  autovar-tests.coffee
                </a>
              
                
                <a class="source" href="denorm-tests.html">
                  denorm-tests.coffee
                </a>
              
                
                <a class="source" href="dict-tests.html">
                  dict-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-client-tests.html">
                  jframework-client-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-tests.html">
                  jframework-tests.coffee
                </a>
              
                
                <a class="source" href="list-tests.html">
                  list-tests.coffee
                </a>
              
                
                <a class="source" href="publish-tests.html">
                  publish-tests.coffee
                </a>
              
                
                <a class="source" href="test-models.html">
                  test-models.coffee
                </a>
              
                
                <a class="source" href="util-tests.html">
                  util-tests.coffee
                </a>
              
                
                <a class="source" href="tracker.html">
                  tracker.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="var.html">
                  var.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>jframework-tests.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015, Quixey Inc.
All rights reserved.</p>
<p>Licensed under the Modified BSD License found in the
LICENSE file in the root directory of this source tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

Tinytest.add <span class="hljs-string">"_init"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This test is just here to soak up
tinytest’s init time so the other
tests’ times aren’t artificially high</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span>


Tinytest.add <span class="hljs-string">"AutoDict - create with fieldSpec instead of keyFunc"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    w = J.Var <span class="hljs-number">9</span>
    changeHist = []
    ad = J.AutoDict(<span class="hljs-string">'ad'</span>,
        <span class="hljs-attribute">x</span>: <span class="hljs-number">5</span>
        <span class="hljs-attribute">y</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>]
        <span class="hljs-attribute">z</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-string">'eight'</span>
        <span class="hljs-attribute">w</span>: <span class="hljs-function">-&gt;</span> w.get()
    ,
        <span class="hljs-attribute">onChange</span>: <span class="hljs-function"><span class="hljs-params">(key, oldValue, newValue)</span> -&gt;</span>
            changeHist.push [key, oldValue ? <span class="hljs-literal">null</span>, newValue ? <span class="hljs-literal">null</span>]
    )
    test.equal ad.toObj(),
        <span class="hljs-attribute">x</span>: <span class="hljs-number">5</span>
        <span class="hljs-attribute">y</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>]
        <span class="hljs-attribute">z</span>: <span class="hljs-string">'eight'</span>
        <span class="hljs-attribute">w</span>: <span class="hljs-number">9</span>
    test.equal ad.y().get(<span class="hljs-number">1</span>), <span class="hljs-number">7</span>
    ad.y().push <span class="hljs-number">88</span>
    w.set <span class="hljs-number">99</span>
    Tracker.flush()
    test.equal ad.toObj(),
        <span class="hljs-attribute">x</span>: <span class="hljs-number">5</span>
        <span class="hljs-attribute">y</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">88</span>]
        <span class="hljs-attribute">z</span>: <span class="hljs-string">'eight'</span>
        <span class="hljs-attribute">w</span>: <span class="hljs-number">99</span>
    Tracker.flush()
    test.equal J.List(changeHist).toArr(), [
        [<span class="hljs-string">'x'</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">5</span>]
        [<span class="hljs-string">'y'</span>, <span class="hljs-literal">null</span>, [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">88</span>]]
        [<span class="hljs-string">'z'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'eight'</span>]
        [<span class="hljs-string">'w'</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">9</span>]
        [<span class="hljs-string">'w'</span>, <span class="hljs-number">9</span>, <span class="hljs-number">99</span>]
    ]
    ad.stop()


Tinytest.add <span class="hljs-string">"AutoDict - create with list of keys instead of keyFunc"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    ad = J.AutoDict(<span class="hljs-string">'ad'</span>,
        [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-string">'z'</span>]
        (key) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{key}</span>-v"</span>
    )
    test.equal ad.getFields(),
        <span class="hljs-attribute">x</span>: <span class="hljs-string">'x-v'</span>
        <span class="hljs-attribute">y</span>: <span class="hljs-string">'y-v'</span>
        <span class="hljs-attribute">z</span>: <span class="hljs-string">'z-v'</span>
    ad.stop()

    lst = J.List [<span class="hljs-string">'q'</span>, <span class="hljs-string">'r'</span>]
    ad = J.AutoDict(<span class="hljs-string">'ad'</span>,
        lst
        (key) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{key}</span>-v"</span>
    )
    test.equal ad.getFields(),
        <span class="hljs-attribute">q</span>: <span class="hljs-string">'q-v'</span>
        <span class="hljs-attribute">r</span>: <span class="hljs-string">'r-v'</span>
    test.isUndefined ad.get(<span class="hljs-string">'s'</span>)
    ad.stop()

    size = J.Var <span class="hljs-number">5</span>
    al = J.AutoList(<span class="hljs-string">'haial'</span>,
        <span class="hljs-function">-&gt;</span> size.get()
        (i) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{i}</span>-k"</span>
        <span class="hljs-literal">true</span>
    )
    ad = J.AutoDict(<span class="hljs-string">'ad'</span>,
        al
        (key) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{key}</span>-v"</span>
    )
    test.equal ad.hasKey(<span class="hljs-string">'3-k'</span>), <span class="hljs-literal">true</span>
    test.equal ad.get(<span class="hljs-string">'3-k'</span>), <span class="hljs-string">'3-k-v'</span>
    test.equal ad.get(<span class="hljs-string">'1-k'</span>), <span class="hljs-string">'1-k-v'</span>
    test.equal ad.getFields(),
        <span class="hljs-string">'0-k'</span>: <span class="hljs-string">'0-k-v'</span>
        <span class="hljs-string">'1-k'</span>: <span class="hljs-string">'1-k-v'</span>
        <span class="hljs-string">'2-k'</span>: <span class="hljs-string">'2-k-v'</span>
        <span class="hljs-string">'3-k'</span>: <span class="hljs-string">'3-k-v'</span>
        <span class="hljs-string">'4-k'</span>: <span class="hljs-string">'4-k-v'</span>
    size.set <span class="hljs-number">4</span>
    Tracker.flush()

    <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Old test when we wouldn’t invalidate
the dict because its keys were an
actual J.List not an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        test.equal ad.getFields(),
            <span class="hljs-string">'0-k'</span>: <span class="hljs-string">'0-k-v'</span>
            <span class="hljs-string">'1-k'</span>: <span class="hljs-string">'1-k-v'</span>
            <span class="hljs-string">'2-k'</span>: <span class="hljs-string">'2-k-v'</span>
            <span class="hljs-string">'3-k'</span>: <span class="hljs-string">'3-k-v'</span>
    al.stop()
    ad.stop()



Tinytest.addAsync <span class="hljs-string">"AfterFlush - sortKey basics"</span>, <span class="hljs-function"><span class="hljs-params">(test, onComplete)</span> -&gt;</span>
    afCount = <span class="hljs-number">0</span>
    aafCount = <span class="hljs-number">0</span>
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        aafCount += <span class="hljs-number">1</span>
        test.equal aafCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 1'</span>
    , <span class="hljs-number">0.7</span>)
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        aafCount += <span class="hljs-number">1</span>
        test.equal aafCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 2'</span>
        Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
            aafCount += <span class="hljs-number">1</span>
            test.equal afCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 3'</span>
            test.equal aafCount, <span class="hljs-number">3</span>, <span class="hljs-string">'fail 4'</span>
            Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
                aafCount += <span class="hljs-number">1</span>
            , <span class="hljs-number">0.7</span>)
            Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
                test.equal aafCount, <span class="hljs-number">4</span>, <span class="hljs-string">'fail 5'</span>
                aafCount += <span class="hljs-number">1</span>
                Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
                    test.equal aafCount, <span class="hljs-number">6</span>, <span class="hljs-string">'fail 6'</span>
                    Meteor.wrapAsync(_.defer) -&gt; onComplete()
                , <span class="hljs-number">0.7</span>)
            , <span class="hljs-number">0.7</span>)
            Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
                test.equal aafCount, <span class="hljs-number">5</span>, <span class="hljs-string">'fail 7'</span>
                aafCount += <span class="hljs-number">1</span>
            , <span class="hljs-number">0.7</span>)
            test.equal afCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 8'</span>
            test.equal aafCount, <span class="hljs-number">3</span>, <span class="hljs-string">'fail 9'</span>
        , <span class="hljs-number">0.7</span>)
        Tracker.afterFlush -&gt;
            afCount += <span class="hljs-number">1</span>
            test.equal afCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 10'</span>
            test.equal aafCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 11'</span>
        Tracker.afterFlush -&gt;
            afCount += <span class="hljs-number">1</span>
            test.equal afCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 12'</span>
            test.equal aafCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 13'</span>
        test.equal afCount, <span class="hljs-number">0</span>, <span class="hljs-string">'fail 14'</span>
        test.equal aafCount, <span class="hljs-number">2</span>, <span class="hljs-string">'fail 15'</span>
    , <span class="hljs-number">0.7</span>)
    test.equal aafCount, <span class="hljs-number">0</span>, <span class="hljs-string">'fail 16'</span>


Tinytest.addAsync <span class="hljs-string">"AfterFlush - trigger high sortKey funcs after all onChange handlers"</span>, <span class="hljs-function"><span class="hljs-params">(test, onComplete)</span> -&gt;</span>
    v = J.Var <span class="hljs-number">6</span>
    onChangeCount = <span class="hljs-number">0</span>
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        test.equal onChangeCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 1'</span>
    , <span class="hljs-number">0.7</span>)
    a = J.AutoVar(<span class="hljs-string">'a'</span>,
        <span class="hljs-function">-&gt;</span> v.get()
        (oldA, newA) -&gt;
            onChangeCount += <span class="hljs-number">1</span>
    )
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        test.equal onChangeCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 2'</span>
    , <span class="hljs-number">0.7</span>)
    test.equal onChangeCount, <span class="hljs-number">0</span>, <span class="hljs-string">'fail 3'</span>
    Tracker.flush()
    test.equal onChangeCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 4'</span>
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        test.equal onChangeCount, <span class="hljs-number">3</span>, <span class="hljs-string">'fail 5'</span>
    , <span class="hljs-number">0.7</span>)
    b = J.AutoVar(<span class="hljs-string">'b'</span>,
        <span class="hljs-function">-&gt;</span> v.get() - v.get() % <span class="hljs-number">2</span>
        (oldB, newB) -&gt;
            onChangeCount += <span class="hljs-number">1</span>
    )
    Tracker.afterFlush(<span class="hljs-function">-&gt;</span>
        test.equal onChangeCount, <span class="hljs-number">3</span>, <span class="hljs-string">'fail 6'</span>
        a.stop()
        b.stop()
        onComplete()
    , <span class="hljs-number">0.7</span>)
    v.set <span class="hljs-number">7</span>
    test.equal onChangeCount, <span class="hljs-number">1</span>, <span class="hljs-string">'fail 7'</span>





Tinytest.add <span class="hljs-string">"AutoDict - deleting a key"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    keys = J.List [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>]
    x = J.Var <span class="hljs-number">5</span>
    hist = []

    ad = J.AutoDict(
        <span class="hljs-string">'ad'</span>
        -&gt; keys
        (key) -&gt;
            hist.push key
            <span class="hljs-string">"v-<span class="hljs-subst">#{key}</span>, <span class="hljs-subst">#{x.get()}</span>"</span>
    )

    test.equal ad.get(<span class="hljs-string">'two'</span>), <span class="hljs-string">'v-two, 5'</span>
    test.equal ad.get(<span class="hljs-string">'one'</span>), <span class="hljs-string">'v-one, 5'</span>
    x.set <span class="hljs-number">6</span>
    Tracker.flush()
    test.equal ad.get(<span class="hljs-string">'one'</span>), <span class="hljs-string">'v-one, 6'</span>
    hist = []
    keys.pop()
    test.isUndefined ad.get(<span class="hljs-string">'two'</span>)
    test.equal hist, [] <span class="hljs-comment"># Recomputing two would be particularly bad</span>
    hist = []
    Tracker.flush()
    test.equal ad.getFields(), {<span class="hljs-string">'zero'</span>: <span class="hljs-string">'v-zero, 6'</span>, <span class="hljs-attribute">one</span>: <span class="hljs-string">'v-one, 6'</span>}
    test.equal hist, [<span class="hljs-string">'zero'</span>]
    Tracker.flush()



Tinytest.add <span class="hljs-string">"AutoDict - delete element onChange"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    changeHistory = []
    al = J.AutoDict(
        <span class="hljs-function">-&gt;</span> <span class="hljs-string">"<span class="hljs-subst">#{x}</span>"</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt; <span class="hljs-string">"val <span class="hljs-subst">#{key}</span>"</span>
        <span class="hljs-attribute">onChange</span>: <span class="hljs-function"><span class="hljs-params">(key, oldValue, newValue)</span> -&gt;</span>
            changeHistory.push [key, oldValue, newValue]
    )
    test.equal al.toObj(),
        <span class="hljs-number">0</span>: <span class="hljs-string">'val 0'</span>
        <span class="hljs-number">1</span>: <span class="hljs-string">'val 1'</span>
        <span class="hljs-number">2</span>: <span class="hljs-string">'val 2'</span>
    test.equal changeHistory, []
    Tracker.flush()
    test.equal changeHistory, [
        [<span class="hljs-string">'0'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">'val 0'</span>]
        [<span class="hljs-string">'1'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">'val 1'</span>]
        [<span class="hljs-string">'2'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">'val 2'</span>]
    ]
    changeHistory = []
    size.set <span class="hljs-number">2</span>
    test.equal changeHistory, []
    Tracker.flush()
    test.equal changeHistory, [
        [<span class="hljs-string">'2'</span>, <span class="hljs-string">'val 2'</span>, <span class="hljs-literal">undefined</span>]
    ]





Tinytest.add <span class="hljs-string">"Dict - basics"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    d = J.Dict()
    d.setOrAdd <span class="hljs-attribute">x</span>: <span class="hljs-number">5</span>
    test.equal d.get(<span class="hljs-string">'x'</span>), <span class="hljs-number">5</span>
    test.equal d.size(), <span class="hljs-number">1</span>
    test.throws -&gt; d.set <span class="hljs-string">'newkey'</span>: <span class="hljs-number">8</span>
    d.setOrAdd <span class="hljs-attribute">y</span>: <span class="hljs-number">7</span>
    test.equal d.toObj(),
        <span class="hljs-attribute">x</span>: <span class="hljs-number">5</span>
        <span class="hljs-attribute">y</span>: <span class="hljs-number">7</span>
    d.clear()
    test.equal d.toObj(), {}
    test.equal d.size(), <span class="hljs-number">0</span>

Tinytest.add <span class="hljs-string">"AutoDict - onChange"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    changeHistory = []
    keysVar = J.Var [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>]
    ad = J.AutoDict(
        <span class="hljs-function">-&gt;</span> keysVar.get()
        (key) -&gt; <span class="hljs-number">5</span>
        <span class="hljs-attribute">onChange</span>: <span class="hljs-function"><span class="hljs-params">(key, oldValue, newValue)</span> -&gt;</span>
            changeHistory.push [key, oldValue, newValue]
    )
    test.equal changeHistory, []
    Tracker.flush()
    test.equal changeHistory, [
        [<span class="hljs-string">'a'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">5</span>]
        [<span class="hljs-string">'b'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">5</span>]
    ]
    changeHistory = []
    keysVar.set [<span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>]
    test.equal changeHistory, []
    Tracker.flush()
    test.equal changeHistory, [
        [<span class="hljs-string">'b'</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">undefined</span>]
        [<span class="hljs-string">'c'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">5</span>]
    ]
    test.equal ad.toObj(),
        <span class="hljs-attribute">a</span>: <span class="hljs-number">5</span>
        <span class="hljs-attribute">c</span>: <span class="hljs-number">5</span>
    ad.stop()


Tinytest.add <span class="hljs-string">"List - basics"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">6</span>, <span class="hljs-number">4</span>]
    test.isTrue lst.contains <span class="hljs-number">4</span>
    test.isFalse lst.contains <span class="hljs-string">"4"</span>
    test.equal lst.get(<span class="hljs-number">0</span>), <span class="hljs-number">6</span>
    test.throws -&gt; lst.get <span class="hljs-string">'0'</span>
    test.throws -&gt; lst.get <span class="hljs-number">2</span>
    test.throws -&gt; lst.get <span class="hljs-number">1.5</span>
    test.equal lst.join(<span class="hljs-string">'*'</span>), <span class="hljs-string">"6*4"</span>
    test.equal lst.map(<span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span> <span class="hljs-number">2</span> * x).toArr(), [<span class="hljs-number">12</span>, <span class="hljs-number">8</span>]
    test.equal lst.toArr(), [<span class="hljs-number">6</span>, <span class="hljs-number">4</span>]
    lst.push <span class="hljs-number">5</span>
    test.equal lst.toArr(), [<span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
    test.equal lst.getSorted().toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
    test.equal lst.toArr(), [<span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
    lst.sort()
    test.equal lst.toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]

    lst = J.List([<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, [<span class="hljs-number">1</span>], <span class="hljs-number">4</span>])
    test.notEqual lst.get(<span class="hljs-number">2</span>), [<span class="hljs-number">1</span>]

Tinytest.add <span class="hljs-string">"List - extend"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>]
    valFuncHistory = []
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span> lst
        (x) -&gt;
            valFuncHistory.push x
            <span class="hljs-string">"val for <span class="hljs-subst">#{x}</span>"</span>
        <span class="hljs-attribute">onChange</span>: <span class="hljs-literal">true</span>
    )
    Tracker.flush()
    test.equal valFuncHistory, [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>]
    valFuncHistory = []
    lst.extend [<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>]
    Tracker.flush()
    test.equal valFuncHistory, [<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>]
    lst = J.List [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>]
    d.stop()

    runCount = <span class="hljs-number">0</span>
    c = Tracker.autorun -&gt;
        runCount += <span class="hljs-number">1</span>
        lst.toArr()
    lst.extend [<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>]
    test.equal runCount, <span class="hljs-number">1</span>
    Tracker.flush()
    test.equal runCount, <span class="hljs-number">2</span>
    c.stop()
    Tracker.flush()


Tinytest.add <span class="hljs-string">"Dict and List reactivity 1"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
    testOutputs = []
    c = Tracker.autorun (c) -&gt;
        testOutputs.push lst.get(<span class="hljs-number">3</span>)
    test.equal testOutputs, [<span class="hljs-number">3</span>]
    lst.set <span class="hljs-number">3</span>, <span class="hljs-number">103</span>
    lst.set <span class="hljs-number">3</span>, <span class="hljs-number">203</span>
    test.equal testOutputs, [<span class="hljs-number">3</span>]
    Tracker.flush()
    test.equal testOutputs, [<span class="hljs-number">3</span>, <span class="hljs-number">203</span>]
    c.stop()

Tinytest.add <span class="hljs-string">"Dict and List reactivity 2"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
    nonreactiveMappedLst = lst.map (x) -&gt; <span class="hljs-number">2</span> * x
    test.equal nonreactiveMappedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>], <span class="hljs-string">"fail 1"</span>

    reactiveMappedLst = <span class="hljs-literal">null</span>
    c = Tracker.autorun (c) -&gt;
        reactiveMappedLst = lst.map (x) -&gt; <span class="hljs-number">2</span> * x
    test.equal reactiveMappedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>], <span class="hljs-string">"fail 2"</span>
    Tracker.flush()
    test.equal reactiveMappedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>], <span class="hljs-string">"fail 2.1"</span>

    lst.set <span class="hljs-number">2</span>, <span class="hljs-number">102</span>
    Tracker.flush()
    test.equal nonreactiveMappedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>], <span class="hljs-string">"fail 3"</span>
    test.equal reactiveMappedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>], <span class="hljs-string">"fail 4"</span>

    c.stop()

Tinytest.add <span class="hljs-string">"Dict and List reactivity 3"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
    c = Tracker.autorun -&gt;
        lst.reverse()
    test.equal lst.toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>], <span class="hljs-string">"Didn't reverse"</span>
    Tracker.flush()
    test.equal lst.toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>], <span class="hljs-string">"Screwed up the reverse"</span>
    c.stop()

Tinytest.add <span class="hljs-string">"List - sort"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
    sortedLst = <span class="hljs-literal">null</span>
    c = Tracker.autorun (c) -&gt;
        sortedLst = lst.getSorted()
        <span class="hljs-keyword">if</span> c.firstRun
            test.equal lst.toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
            test.equal sortedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
            lst.set <span class="hljs-number">1</span>, <span class="hljs-number">5</span>
        <span class="hljs-keyword">else</span>
            test.equal lst.toArr(), [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
            test.equal sortedLst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
            c.stop()
    Tracker.flush()


Tinytest.add <span class="hljs-string">"AutoDict - Basics"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span> [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>, <span class="hljs-string">'five'</span>][<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{key}</span> is a number"</span>
    )
    Tracker.flush()
    test.equal d.getKeys(), [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>]
    test.equal d.toObj(), {<span class="hljs-string">'zero'</span>: <span class="hljs-string">"zero is a number"</span>, <span class="hljs-string">'one'</span>: <span class="hljs-string">"one is a number"</span>, <span class="hljs-string">'two'</span>: <span class="hljs-string">"two is a number"</span>}
    test.equal d.size(), <span class="hljs-number">3</span>
    test.equal d.get(<span class="hljs-string">'two'</span>), <span class="hljs-string">"two is a number"</span>
    test.isUndefined d.get(<span class="hljs-string">'four'</span>)
    size.set <span class="hljs-number">4</span>
    test.equal d.size(), <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal d.size(), <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal d.size(), <span class="hljs-number">4</span>
    test.equal d.getKeys(), [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>]
    test.equal d.get(<span class="hljs-string">'three'</span>), <span class="hljs-string">"three is a number"</span>


Tinytest.add <span class="hljs-string">"AutoDict - computation ownership"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    valueFuncRuns = <span class="hljs-number">0</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span> [<span class="hljs-string">'j'</span>, <span class="hljs-string">'k'</span>]
        (key) -&gt;
            valueFuncRuns += <span class="hljs-number">1</span>
            key + <span class="hljs-string">'-v'</span>
    )

    c = Tracker.autorun (c) -&gt;
        d.getFields()

    test.equal valueFuncRuns, <span class="hljs-number">2</span>
    test.isTrue d._fields[<span class="hljs-string">'j'</span>].creator <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
    Tracker.flush()
    c.stop()
    Tracker.flush()
    test.equal valueFuncRuns, <span class="hljs-number">2</span>


Tinytest.add <span class="hljs-string">"AutoDict - reactivity"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">2</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span>
            [<span class="hljs-string">'3'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'7'</span>][<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt;
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'7'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'xxx'</span> <span class="hljs-keyword">else</span> coef.get() * parseInt(key)
    )
    dHistory = []
    watcher = Tracker.autorun =&gt;
        dHistory.push d.getFields()
    watcher.onInvalidate =&gt; <span class="hljs-built_in">console</span>.info <span class="hljs-string">"INVALIDATED WATCHER"</span>
    test.equal dHistory.pop(), {
        <span class="hljs-number">3</span>: <span class="hljs-number">6</span>
        <span class="hljs-number">5</span>: <span class="hljs-number">10</span>
        <span class="hljs-number">9</span>: <span class="hljs-number">18</span>
    }

    coef.set <span class="hljs-number">10</span>
    Tracker.flush()
    test.equal dHistory.pop(), {
        <span class="hljs-number">3</span>: <span class="hljs-number">30</span>
        <span class="hljs-number">5</span>: <span class="hljs-number">50</span>
        <span class="hljs-number">9</span>: <span class="hljs-number">90</span>
    }
    size.set <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal dHistory.pop(), {
        <span class="hljs-number">3</span>: <span class="hljs-number">30</span>
        <span class="hljs-number">5</span>: <span class="hljs-number">50</span>
        <span class="hljs-number">9</span>: <span class="hljs-number">90</span>
        <span class="hljs-number">7</span>: <span class="hljs-string">'xxx'</span>
    }
    watcher.stop()

    watcher = Tracker.autorun =&gt;
        dHistory.push d.get(<span class="hljs-string">'7'</span>)
    test.equal dHistory.pop(), <span class="hljs-string">'xxx'</span>
    coef.set <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal dHistory.length, <span class="hljs-number">0</span>
    watcher.stop()
    d.stop()


Tinytest.add <span class="hljs-string">"AutoDict - laziness"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">2</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    keyFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span>
            keyFuncRunCount += <span class="hljs-number">1</span>
            [<span class="hljs-string">'3'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'7'</span>][<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt;
            valueFuncRunCount += <span class="hljs-number">1</span>
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'7'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'xxx'</span> <span class="hljs-keyword">else</span> coef.get() * parseInt(key)
    )
    test.equal keyFuncRunCount, <span class="hljs-number">0</span>
    test.equal valueFuncRunCount, <span class="hljs-number">0</span>
    test.equal d.get(<span class="hljs-string">'3'</span>), <span class="hljs-number">6</span>
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">1</span>
    test.equal d.get(<span class="hljs-string">'3'</span>), <span class="hljs-number">6</span>
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">1</span>
    Tracker.flush()
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">1</span>
    test.equal d.get(<span class="hljs-string">'9'</span>), <span class="hljs-number">18</span>
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">2</span>
    Tracker.flush()
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">2</span>


Tinytest.add <span class="hljs-string">"AutoList - reactivity 1"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">10</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    sizeFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    al = J.AutoList(
        <span class="hljs-function">-&gt;</span>
            sizeFuncRunCount += <span class="hljs-number">1</span>
            size.get()
        (i) -&gt;
            valueFuncRunCount += <span class="hljs-number">1</span>
            i * coef.get()
    )
    test.equal sizeFuncRunCount, <span class="hljs-number">0</span>
    test.equal valueFuncRunCount, <span class="hljs-number">0</span>
    test.equal al.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]
    test.throws -&gt; al.set <span class="hljs-number">2</span>, <span class="hljs-number">2</span>
    size.set <span class="hljs-number">2</span>
    coef.set <span class="hljs-number">100</span>
    test.equal sizeFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    Tracker.flush()
    test.equal sizeFuncRunCount, <span class="hljs-number">2</span>
    test.equal valueFuncRunCount, <span class="hljs-number">5</span>
    test.equal al.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">100</span>]
    coef.set <span class="hljs-number">1000</span>
    Tracker.flush()
    test.equal al.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>]
    test.equal sizeFuncRunCount, <span class="hljs-number">2</span>
    test.equal valueFuncRunCount, <span class="hljs-number">7</span>


Tinytest.add <span class="hljs-string">"AutoList - onChange"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">10</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    sizeFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    onChangeHistory = []
    al = J.AutoList(
        <span class="hljs-function">-&gt;</span>
            sizeFuncRunCount += <span class="hljs-number">1</span>
            size.get()
        (i) -&gt;
            valueFuncRunCount += <span class="hljs-number">1</span>
            i * coef.get()
        (i, oldValue, newValue) -&gt;
            onChangeHistory.push [i, oldValue, newValue, <span class="hljs-property">@size</span>()]
    )
    test.equal sizeFuncRunCount, <span class="hljs-number">0</span>
    test.equal valueFuncRunCount, <span class="hljs-number">0</span>
    test.equal onChangeHistory, []
    Tracker.flush()
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    test.equal onChangeHistory, [
        [<span class="hljs-number">0</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>]
        [<span class="hljs-number">1</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">10</span>, <span class="hljs-number">3</span>]
        [<span class="hljs-number">2</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">20</span>, <span class="hljs-number">3</span>]
    ]
    onChangeHistory = []
    test.equal al.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    size.set <span class="hljs-number">5</span>
    test.equal onChangeHistory, []
    Tracker.flush()
    test.equal al.size(), <span class="hljs-number">5</span>
    test.equal onChangeHistory, [
        [<span class="hljs-number">3</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">30</span>, <span class="hljs-number">5</span>]
        [<span class="hljs-number">4</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">40</span>, <span class="hljs-number">5</span>]
    ]
    onChangeHistory = []
    size.set <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal al.size(), <span class="hljs-number">4</span>
    test.equal onChangeHistory, [
        [<span class="hljs-number">4</span>, <span class="hljs-number">40</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">4</span>]
    ]
    coef.set <span class="hljs-number">100</span>
    Tracker.flush()
    test.equal al.get(<span class="hljs-number">2</span>), <span class="hljs-number">200</span>
    test.isTrue _.any (J.util.equals(x, [<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">4</span>]) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> onChangeHistory)
    test.isTrue _.any (J.util.equals(x, [<span class="hljs-number">2</span>, <span class="hljs-number">20</span>, <span class="hljs-number">200</span>, <span class="hljs-number">4</span>]) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> onChangeHistory)
    test.isTrue _.any (J.util.equals(x, [<span class="hljs-number">3</span>, <span class="hljs-number">30</span>, <span class="hljs-number">300</span>, <span class="hljs-number">4</span>]) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> onChangeHistory)


Tinytest.add <span class="hljs-string">"AutoList - onChange 2"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">10</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">5</span>
    sizeFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    onChangeHistory = []
    al = J.AutoList(
        <span class="hljs-function">-&gt;</span>
            sizeFuncRunCount += <span class="hljs-number">1</span>
            size.get()
        (i) -&gt;
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">'compute'</span>, i
            valueFuncRunCount += <span class="hljs-number">1</span>
            i * coef.get()
        (i, oldValue, newValue) -&gt;
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">'onchange'</span>, i, oldValue, newValue
            onChangeHistory.push [i, oldValue, newValue, <span class="hljs-property">@size</span>()]
    )
    Tracker.flush()
    onChangeHistory = []
    size.set <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal onChangeHistory, [
        [<span class="hljs-number">4</span>, <span class="hljs-number">40</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">4</span>]
    ]
    al.stop()


Tinytest.add <span class="hljs-string">"List - reverse"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
    reversed = lst.getReversed()
    test.equal lst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
    test.equal reversed.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
    lst.set <span class="hljs-number">2</span>, <span class="hljs-number">22</span>
    test.equal reversed.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
    test.equal lst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">3</span>]
    reversed = <span class="hljs-literal">null</span>

    c = Tracker.autorun (c) -&gt;
        reversed = lst.getReversed()
    test.equal reversed.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">22</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
    lst.set <span class="hljs-number">2</span>, <span class="hljs-number">222</span>
    Tracker.flush()
    test.equal reversed.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">222</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
    test.isFalse c.invalidated
    lst.set <span class="hljs-number">2</span>, <span class="hljs-number">2</span>
    c.stop()
    test.throws -&gt; reversed.get <span class="hljs-number">2</span>
    test.throws -&gt; reversed.toArr()
    test.equal lst.toArr(), [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]


Tinytest.add <span class="hljs-string">"List - getConcat"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst1 = J.List [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
    lst2 = J.List [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
    concatted = lst1.getConcat lst2
    Tracker.flush()
    test.equal concatted.get(<span class="hljs-number">2</span>), <span class="hljs-number">6</span>
    test.equal concatted.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
    test.throws -&gt; concatted.get <span class="hljs-number">6</span>
    lst1.push <span class="hljs-string">'x'</span>
    Tracker.flush()
    test.equal concatted.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
    c = Tracker.autorun (c) -&gt;
        concatted = lst1.getConcat lst2
    test.equal concatted.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">'x'</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
    lst1.push <span class="hljs-string">'y'</span>
    Tracker.flush()
    test.equal concatted.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
    lst2.set <span class="hljs-number">1</span>, <span class="hljs-string">'z'</span>
    Tracker.flush()
    test.equal concatted.toArr(), [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-number">7</span>, <span class="hljs-string">'z'</span>]
    test.equal concatted.get(<span class="hljs-number">0</span>), <span class="hljs-number">3</span>
    c.stop()
    Tracker.flush() <span class="hljs-comment"># Intentionally testing flushing after stopping</span>

Tinytest.add <span class="hljs-string">"List - .contains reactivity"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
    containsHistory = []
    lastContains = <span class="hljs-literal">null</span>
    Tracker.autorun -&gt;
        lastContains = lst.contains <span class="hljs-number">2</span>
        containsHistory.push lastContains
    test.isTrue lastContains
    lst.set <span class="hljs-number">3</span>, <span class="hljs-number">33</span>
    Tracker.flush()
    test.isTrue lastContains
    lst.set <span class="hljs-number">2</span>, <span class="hljs-number">22</span>
    Tracker.flush()
    test.isFalse lastContains
    lst.set <span class="hljs-number">4</span>, <span class="hljs-number">2</span>
    Tracker.flush()
    test.isTrue lastContains
    lst.set <span class="hljs-number">4</span>, <span class="hljs-number">4</span>
    Tracker.flush()
    test.isFalse lastContains
    lst.push <span class="hljs-number">5</span>
    Tracker.flush()
    test.isFalse lastContains
    lst.push <span class="hljs-number">2</span>
    Tracker.flush()
    test.isTrue lastContains
    lst.push <span class="hljs-number">3</span>
    Tracker.flush()
    test.isTrue lastContains


Tinytest.add <span class="hljs-string">"AutoDict - Don't recalculate dead keys"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    val = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">100</span>
    keyFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span>
            keyFuncRunCount += <span class="hljs-number">1</span>
            <span class="hljs-string">"<span class="hljs-subst">#{x}</span>"</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt;
            valueFuncRunCount += <span class="hljs-number">1</span>
            val.get() + parseInt key
    )
    test.equal keyFuncRunCount, <span class="hljs-number">0</span>
    test.equal valueFuncRunCount, <span class="hljs-number">0</span>
    Tracker.flush()
    test.equal d.toObj(),
        <span class="hljs-number">0</span>: <span class="hljs-number">100</span>
        <span class="hljs-number">1</span>: <span class="hljs-number">101</span>
        <span class="hljs-number">2</span>: <span class="hljs-number">102</span>
    test.equal keyFuncRunCount, <span class="hljs-number">1</span>
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    size.set <span class="hljs-number">2</span>
    Tracker.flush()
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    test.isUndefined d.get(<span class="hljs-string">'2'</span>)
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    test.equal d.get(<span class="hljs-string">'1'</span>), <span class="hljs-number">101</span>
    test.equal valueFuncRunCount, <span class="hljs-number">3</span>
    val.set <span class="hljs-number">200</span>
    Tracker.flush()
    test.isUndefined d.get(<span class="hljs-string">'2'</span>)
    test.equal valueFuncRunCount, <span class="hljs-number">5</span>
    test.equal d.get(<span class="hljs-string">'1'</span>), <span class="hljs-number">201</span>
    test.equal valueFuncRunCount, <span class="hljs-number">5</span>
    Tracker.flush()
    test.equal valueFuncRunCount, <span class="hljs-number">5</span>
    d.stop()


Tinytest.add <span class="hljs-string">"AutoDict - Make sure key still exists when expediting value recalculation"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    size = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">3</span>
    val = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">100</span>
    keysFuncRunCount = <span class="hljs-number">0</span>
    valueFuncRunCount = <span class="hljs-number">0</span>
    d = J.AutoDict(
        <span class="hljs-function">-&gt;</span>
            keysFuncRunCount += <span class="hljs-number">1</span>
            <span class="hljs-string">"<span class="hljs-subst">#{x}</span>"</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..size.get()]
        (key) -&gt;
            valueFuncRunCount += <span class="hljs-number">1</span>
            val.get() + parseInt key
    )
    size.set <span class="hljs-number">2</span>
    test.isUndefined d.get(<span class="hljs-string">'2'</span>)
    Tracker.flush()
    test.equal d.toObj(),
        <span class="hljs-number">0</span>: <span class="hljs-number">100</span>
        <span class="hljs-number">1</span>: <span class="hljs-number">101</span>
    val.set <span class="hljs-number">200</span>
    size.set <span class="hljs-number">1</span>
    test.isUndefined d.get(<span class="hljs-string">'1'</span>)
    size.set <span class="hljs-number">0</span>
    val.set <span class="hljs-number">300</span>
    test.isUndefined d.get(<span class="hljs-string">'0'</span>)




Tinytest.add <span class="hljs-string">"Dict - don't invalidate creator computation"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    runCount = <span class="hljs-number">0</span>
    runCount2 = <span class="hljs-number">0</span>

    d = <span class="hljs-literal">null</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-number">1</span>
    c1 = Tracker.autorun (c) -&gt;
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">'run1'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Since this autorun is creating d,
it won’t invalidate when it’s the
one mutating d.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        runCount += <span class="hljs-number">1</span>
        d ?= J.Dict()
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">11</span>
        d.size()
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">12</span>
        d.setOrAdd <span class="hljs-string">'a'</span>, (d.get(<span class="hljs-string">'a'</span>) ? <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">13</span>
        d.hasKey <span class="hljs-string">'b'</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">14</span>
        d.setOrAdd <span class="hljs-string">'b'</span>, <span class="hljs-number">4</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">15</span>
        test.isTrue d.hasKey <span class="hljs-string">'b'</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-number">16</span>
        ret = d.a()
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">'done1'</span>
        ret
    c2 = Tracker.autorun -&gt;
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">'run2'</span>
        runCount2 += <span class="hljs-number">1</span>
        ret = d.get(<span class="hljs-string">'a'</span>)
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">'done2'</span>
        ret
    <span class="hljs-built_in">console</span>.log <span class="hljs-number">2</span>
    test.equal runCount, <span class="hljs-number">1</span>
    test.equal runCount2, <span class="hljs-number">1</span>
    Tracker.flush()
    <span class="hljs-built_in">console</span>.log <span class="hljs-number">3</span>
    test.equal runCount, <span class="hljs-number">1</span>
    test.equal runCount2, <span class="hljs-number">1</span>



Tinytest.addAsync <span class="hljs-string">"AutoList - Maps don't stop prematurely"</span>, <span class="hljs-function"><span class="hljs-params">(test, onComplete)</span> -&gt;</span>
    coef = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">2</span>
    lst = J.List [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
    mappedLst = lst.map (v) -&gt; coef.get() * v
    test.equal mappedLst.getValues(), [<span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>]
    coef.set <span class="hljs-number">3</span>
    test.equal mappedLst.getValues(), [<span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>]

    av = J.AutoVar <span class="hljs-string">'av'</span>,
        <span class="hljs-function">-&gt;</span> lst.map (v) -&gt; coef.get() * v

    test.equal av.get().getValues(), [<span class="hljs-number">9</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>]
    coef.set <span class="hljs-number">4</span>
    Tracker.flush()
    test.equal av.get().getValues(), [<span class="hljs-number">12</span>, <span class="hljs-number">16</span>, <span class="hljs-number">20</span>]
    av.stop()
    test.throws -&gt; av.get().getValues()

    onComplete()




Tinytest.add <span class="hljs-string">"AutoVar - Invalidation non-propagation"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    history = []
    x = <span class="hljs-keyword">new</span> J.Var <span class="hljs-number">5</span>
    a = J.AutoVar <span class="hljs-string">'a'</span>, <span class="hljs-function">-&gt;</span>
        history.push <span class="hljs-string">'a'</span>
        x.get()
    b = J.AutoVar <span class="hljs-string">'b'</span>, <span class="hljs-function">-&gt;</span>
        history.push <span class="hljs-string">'b'</span>
        Math.floor(a.get() / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span> <span class="hljs-comment"># Round down to nearest 100</span>
    c = J.AutoVar <span class="hljs-string">'c'</span>, <span class="hljs-function">-&gt;</span>
        history.push <span class="hljs-string">'c'</span>
        b.get()
    d = J.AutoVar <span class="hljs-string">'d'</span>, <span class="hljs-function">-&gt;</span>
        history.push <span class="hljs-string">'d'</span>
        c.get()
    test.equal c.get(), <span class="hljs-number">0</span>
    test.equal history, [<span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>]
    history = []
    x.set <span class="hljs-number">55</span>
    Tracker.flush()
    test.equal c.get(), <span class="hljs-number">0</span>
    test.isTrue <span class="hljs-string">'a'</span> <span class="hljs-keyword">in</span> history
    test.isTrue <span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> history
    test.isFalse <span class="hljs-string">'c'</span> <span class="hljs-keyword">in</span> history <span class="hljs-comment"># Currently fails</span>
    history = []
    x.set <span class="hljs-number">101</span>
    Tracker.flush()
    test.equal c.get(), <span class="hljs-number">100</span>
    test.isTrue <span class="hljs-string">'a'</span> <span class="hljs-keyword">in</span> history
    test.isTrue <span class="hljs-string">'c'</span> <span class="hljs-keyword">in</span> history
    history = []
    d.get()
    history = []
    x.set <span class="hljs-number">102</span>
    Tracker.flush()
    d.get()
    test.isTrue <span class="hljs-string">'a'</span> <span class="hljs-keyword">in</span> history
    test.isTrue <span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> history
    test.isFalse <span class="hljs-string">'c'</span> <span class="hljs-keyword">in</span> history
    test.isFalse <span class="hljs-string">'d'</span> <span class="hljs-keyword">in</span> history


Tinytest.add <span class="hljs-string">"Programming patterns - Mutation in a forEach"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    mySet = {}

    J.List([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]).forEach (x) -&gt;
        mySet[x] = <span class="hljs-literal">true</span>

    test.equal mySet, <span class="hljs-attribute">a</span>: <span class="hljs-literal">true</span>, <span class="hljs-attribute">b</span>: <span class="hljs-literal">true</span>, <span class="hljs-attribute">c</span>: <span class="hljs-literal">true</span>


Tinytest.add <span class="hljs-string">"List - slice"</span>, <span class="hljs-function"><span class="hljs-params">(test)</span> -&gt;</span>
    lst = J.List [<span class="hljs-string">'zero'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>]
    runCount = <span class="hljs-number">0</span>
    s = J.AutoVar(
        <span class="hljs-string">'s'</span>
        -&gt;
            runCount += <span class="hljs-number">1</span>
            lst.slice <span class="hljs-number">1</span>, <span class="hljs-number">2</span>
    )
    test.equal s.get().size(), <span class="hljs-number">1</span>
    test.equal s.get().get(<span class="hljs-number">0</span>), <span class="hljs-string">'one'</span>
    s.get()
    s.get()
    lst.set <span class="hljs-number">1</span>, <span class="hljs-string">'ONE'</span>
    Tracker.flush()
    test.equal s.get().get(<span class="hljs-number">0</span>), <span class="hljs-string">'ONE'</span>
    s.get()
    s.get()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>test.equal runCount, 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lst.set <span class="hljs-number">2</span>, <span class="hljs-string">'TWO'</span>
    Tracker.flush()
    lst.set <span class="hljs-number">4</span>, <span class="hljs-string">'FOUR'</span>
    Tracker.flush()
    test.equal s.get().get(<span class="hljs-number">0</span>), <span class="hljs-string">'ONE'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>test.equal runCount, 1</p>

            </div>
            
        </li>
        
    </ul>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="http://fuelyourcoding.com/scripts/toc/js/jquery.tableofcontents.min.js"></script>
  <script>
    $(function () {
      $("h1").first().after("<ul id='toc'>").after("<hr>");
      $("#toc").after("<hr>").tableOfContents(null, {
        startLevel: 2,
        depth: 10
      });
    });
  </script>
</body>
</html>

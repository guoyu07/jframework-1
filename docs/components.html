<!DOCTYPE html>

<html>
<head>
  <title>components.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="autodict.html">
                  autodict.coffee
                </a>
              
                
                <a class="source" href="autolist.html">
                  autolist.coffee
                </a>
              
                
                <a class="source" href="autovar.html">
                  autovar.coffee
                </a>
              
                
                <a class="source" href="components.html">
                  components.coffee
                </a>
              
                
                <a class="source" href="AreYouSure.html">
                  AreYouSure.coffee
                </a>
              
                
                <a class="source" href="Button.html">
                  Button.coffee
                </a>
              
                
                <a class="source" href="CancelButton.html">
                  CancelButton.coffee
                </a>
              
                
                <a class="source" href="DeleteButton.html">
                  DeleteButton.coffee
                </a>
              
                
                <a class="source" href="Dropdown.html">
                  Dropdown.coffee
                </a>
              
                
                <a class="source" href="EditButton.html">
                  EditButton.coffee
                </a>
              
                
                <a class="source" href="Expandable.html">
                  Expandable.coffee
                </a>
              
                
                <a class="source" href="KeyValueTable.html">
                  KeyValueTable.coffee
                </a>
              
                
                <a class="source" href="LinkButton.html">
                  LinkButton.coffee
                </a>
              
                
                <a class="source" href="Loader.html">
                  Loader.coffee
                </a>
              
                
                <a class="source" href="SubmitCancelDelete.html">
                  SubmitCancelDelete.coffee
                </a>
              
                
                <a class="source" href="TableRow.html">
                  TableRow.coffee
                </a>
              
                
                <a class="source" href="TextBox.html">
                  TextBox.coffee
                </a>
              
                
                <a class="source" href="denorm.html">
                  denorm.coffee
                </a>
              
                
                <a class="source" href="dict.html">
                  dict.coffee
                </a>
              
                
                <a class="source" href="dom.html">
                  dom.coffee
                </a>
              
                
                <a class="source" href="BooksDemo.html">
                  BooksDemo.coffee
                </a>
              
                
                <a class="source" href="SampleData.html">
                  SampleData.coffee
                </a>
              
                
                <a class="source" href="BatteryApi.html">
                  BatteryApi.coffee
                </a>
              
                
                <a class="source" href="ChatRoom.html">
                  ChatRoom.coffee
                </a>
              
                
                <a class="source" href="Home.html">
                  Home.coffee
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.coffee
                </a>
              
                
                <a class="source" href="NotFound.html">
                  NotFound.coffee
                </a>
              
                
                <a class="source" href="chat.html">
                  chat.coffee
                </a>
              
                
                <a class="source" href="routes.html">
                  routes.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="fetching.html">
                  fetching.coffee
                </a>
              
                
                <a class="source" href="j.html">
                  j.coffee
                </a>
              
                
                <a class="source" href="list.html">
                  list.coffee
                </a>
              
                
                <a class="source" href="models.html">
                  models.coffee
                </a>
              
                
                <a class="source" href="proptypes.html">
                  proptypes.coffee
                </a>
              
                
                <a class="source" href="publish.html">
                  publish.coffee
                </a>
              
                
                <a class="source" href="routing.html">
                  routing.coffee
                </a>
              
                
                <a class="source" href="autovar-tests.html">
                  autovar-tests.coffee
                </a>
              
                
                <a class="source" href="denorm-tests.html">
                  denorm-tests.coffee
                </a>
              
                
                <a class="source" href="dict-tests.html">
                  dict-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-client-tests.html">
                  jframework-client-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-tests.html">
                  jframework-tests.coffee
                </a>
              
                
                <a class="source" href="list-tests.html">
                  list-tests.coffee
                </a>
              
                
                <a class="source" href="publish-tests.html">
                  publish-tests.coffee
                </a>
              
                
                <a class="source" href="test-models.html">
                  test-models.coffee
                </a>
              
                
                <a class="source" href="util-tests.html">
                  util-tests.coffee
                </a>
              
                
                <a class="source" href="tracker.html">
                  tracker.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="var.html">
                  var.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>components.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015, Quixey Inc.
All rights reserved.</p>
<p>Licensed under the Modified BSD License found in the
LICENSE file in the root directory of this source tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
J.components = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>J.c et al store a reference to every mounted
component for easy console debugging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>J.c = J._componentById = {} <span class="hljs-comment"># componentId: component</span>
J.cid = J._componentDomById = {} <span class="hljs-comment"># componentId: componentDOMNode</span>
J.cn = J._componentsByName = {} <span class="hljs-comment"># componentName: {componentId: component}</span>
J.cd = J._componentDomsByName = {} <span class="hljs-comment"># componentName: {componentId: componentDOMNode}</span>
J._nextComponentId = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Queue up all component definitions to help the J
framework startup sequence. E.g. all models
must be defined before all components.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>componentDefinitionQueue = []

componentDebug = Meteor.settings?.public?.jframework?.debug?.components ? <span class="hljs-literal">false</span>
componentDebugStack = []
<span class="hljs-function"><span class="hljs-title">_pushDebugFlag</span> = <span class="hljs-params">(flag = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    componentDebugStack.push componentDebug
    componentDebug = flag ? componentDebug
<span class="hljs-function"><span class="hljs-title">_popDebugFlag</span> = -&gt;</span>
    J.assert componentDebugStack.length &gt; <span class="hljs-number">0</span>
    componentDebug = componentDebugStack.pop()

_debugDepth = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">_getDebugPrefix</span> = <span class="hljs-params">(component = <span class="hljs-literal">null</span>, tabWidth = <span class="hljs-number">4</span>)</span> -&gt;</span>
    numSpaces = Math.max <span class="hljs-number">0</span>, tabWidth * (_debugDepth + <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>
    <span class="hljs-string">"<span class="hljs-subst">#{(<span class="hljs-string">' '</span><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..numSpaces]).join(<span class="hljs-string">''</span>)}</span><span class="hljs-subst">#{<span class="hljs-keyword">if</span> component? <span class="hljs-keyword">and</span> _debugDepth <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> component.toString() <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span>"</span>


J.dc = J.defineComponent = <span class="hljs-function"><span class="hljs-params">(componentName, componentSpec)</span> -&gt;</span>
    componentDefinitionQueue.push
        <span class="hljs-attribute">name</span>: componentName
        <span class="hljs-attribute">spec</span>: componentSpec</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Transform J.List to array anywhere in the element children hierarchy
and J.Dicts to plain objects in the case of the “style” property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">unpackRenderSpec</span> = <span class="hljs-params">(elem)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> React.isValidElement elem
        <span class="hljs-keyword">if</span> _.isArray elem.props.children
            elem.props.children = (unpackRenderSpec e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> elem.props.children)
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> elem.props.children?
            elem.props.children = unpackRenderSpec elem.props.children
        <span class="hljs-keyword">if</span> elem.props.style <span class="hljs-keyword">instanceof</span> J.Dict
            elem.props.style = elem.props.style.toObj()
        elem
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> elem <span class="hljs-keyword">instanceof</span> J.List
        unpackRenderSpec e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> elem.getValues()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> _.isArray elem
        unpackRenderSpec e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> elem
    <span class="hljs-keyword">else</span>
        elem


J._defineComponent = <span class="hljs-function"><span class="hljs-params">(componentName, componentSpec)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> memberName <span class="hljs-keyword">in</span> [
        <span class="hljs-string">'getDefaultProps'</span>
        <span class="hljs-string">'getInitialState'</span>
        <span class="hljs-string">'componentWillReceiveProps'</span>
        <span class="hljs-string">'shouldComponentUpdate'</span>
        <span class="hljs-string">'componentWillUpdate'</span>
    ]
        <span class="hljs-keyword">if</span> memberName <span class="hljs-keyword">of</span> componentSpec
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Unnecessary to define <span class="hljs-subst">#{memberName}</span> for JFramework components
                (in <span class="hljs-subst">#{componentName}</span>)"</span>
    <span class="hljs-keyword">if</span> componentSpec.componentDidUpdate? <span class="hljs-keyword">and</span> componentSpec.componentDidUpdate.length &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"J.Component.componentDidUpdate methods can't take
            arguments. Use reactive expressions if you care about that stuff."</span>

    <span class="hljs-keyword">unless</span> _.isFunction componentSpec.render
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Missing <span class="hljs-subst">#{componentName}</span>.render method"</span>

    reactSpec = _.clone componentSpec
    <span class="hljs-keyword">delete</span> reactSpec.props
    <span class="hljs-keyword">delete</span> reactSpec.state
    <span class="hljs-keyword">delete</span> reactSpec.reactives
    <span class="hljs-keyword">delete</span> reactSpec.debug</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Wrap function calls with debug logs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> memberName, member <span class="hljs-keyword">of</span> componentSpec
        <span class="hljs-keyword">if</span> memberName <span class="hljs-keyword">isnt</span> <span class="hljs-string">'render'</span> <span class="hljs-keyword">and</span> _.isFunction member
            reactSpec[memberName] = <span class="hljs-keyword">do</span> (memberName, member) -&gt; -&gt;
                _pushDebugFlag componentSpec.debug
                <span class="hljs-keyword">if</span> componentDebug
                    <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"<span class="hljs-subst">#{memberName}</span>!"</span>
                    _debugDepth += <span class="hljs-number">1</span>

                memberValue = member.apply @, arguments

                <span class="hljs-keyword">if</span> componentDebug
                    _debugDepth -= <span class="hljs-number">1</span>
                    _popDebugFlag()
                memberValue

    propSpecs = _.clone componentSpec.props ? {}
    propSpecs.className ?=
        <span class="hljs-attribute">type</span>: $$.str
    propSpecs.children ?=
        <span class="hljs-attribute">type</span>: $$.<span class="hljs-keyword">or</span>(
            $$.elem
            $$.list <span class="hljs-attribute">of</span>: $$.elem
        )

    reactSpec.displayName = componentName

    reactSpec.propTypes = {} <span class="hljs-comment"># <span class="hljs-doctag"><span class="hljs-keyword">TODO</span></span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Make getter/setter fields for @state, e.g. @a gets/sets @state.a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> stateFieldName, stateFieldSpec <span class="hljs-keyword">of</span> componentSpec.state ? {}
        <span class="hljs-keyword">if</span> stateFieldName <span class="hljs-keyword">of</span> reactSpec
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Name conflict between <span class="hljs-subst">#{componentName}</span>.<span class="hljs-subst">#{stateFieldName}</span> and
                <span class="hljs-subst">#{componentName}</span>.state.<span class="hljs-subst">#{stateFieldName}</span>"</span>

        reactSpec[stateFieldName] = <span class="hljs-keyword">do</span> (stateFieldName) -&gt; (value) -&gt;
            <span class="hljs-keyword">if</span> arguments.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Can't pass undefined to <span class="hljs-subst">#{componentName}</span>.<span class="hljs-subst">#{stateFieldName}</span>"</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Getter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _pushDebugFlag stateFieldSpec.debug ? componentSpec.debug

                stateValue = <span class="hljs-property">@state</span>[stateFieldName].get()

                <span class="hljs-keyword">if</span> componentDebug
                    <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"<span class="hljs-subst">#{stateFieldName}</span>()"</span>, stateValue
                _popDebugFlag()

                stateValue
            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                stateFields = {}
                stateFields[stateFieldName] = value
                <span class="hljs-property">@set</span> stateFields</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Make reactive getters for @reactives, e.g. @a gets/sets @reactives.a</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>For J.Routable components, make sure there is an explicit or implicit route reactive.
This reactive has the special ability to return dicts with undefined values because
we wrap it in withoutUndefined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reactiveSpecByName = _.clone componentSpec.reactives ? {}
    <span class="hljs-keyword">if</span> J.Routable <span class="hljs-keyword">in</span> (componentSpec.mixins ? [])</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set up reactives._urlWatcher whose onChange triggers stateFromRoute. This
onChange handler should run <em>before</em> the first onChange handler of
reactives.route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> componentSpec.stateFromRoute?
            reactiveSpecByName._urlWatcher =
                <span class="hljs-attribute">val</span>: <span class="hljs-function">-&gt;</span>
                    J._urlVar.get()
                <span class="hljs-attribute">early</span>: <span class="hljs-literal">true</span>
                <span class="hljs-attribute">onChange</span>: <span class="hljs-function"><span class="hljs-params">(oldUrl, newUrl)</span> -&gt;</span>
                    stateFromRoute = J.util.withoutUndefined <span class="hljs-property">@stateFromRoute</span> <span class="hljs-property">@getParams</span>(), <span class="hljs-property">@_cleanQueryFromRaw</span>()
                    <span class="hljs-keyword">for</span> stateFieldName, initialValue <span class="hljs-keyword">of</span> stateFromRoute
                        <span class="hljs-keyword">if</span> stateFieldName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> componentSpec.state
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.stateFromRoute returned invalid stateFieldName:
                                    <span class="hljs-subst">#{JSON.stringify stateFieldName}</span>"</span>
                    _.extend <span class="hljs-property">@_canonicalState</span>, stateFromRoute
                    <span class="hljs-property">@set</span> stateFromRoute</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Set up reactives.route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        origRouteValFunc = reactiveSpecByName.route?.val ? -&gt;
            <span class="hljs-attribute">params</span>: {}
            <span class="hljs-attribute">query</span>: {}
        reactiveSpecByName.route ?= {}
        reactiveSpecByName.route.val = <span class="hljs-function">-&gt;</span>
            J.util.withoutUndefined origRouteValFunc.call @
<span class="hljs-function">
        <span class="hljs-title">pushNewRoute</span> = <span class="hljs-params">(oldRouteSpec, newRouteSpec)</span> -&gt;</span>
            currentRoutes = <span class="hljs-property">@getRoutes</span>()
            lastRoute = currentRoutes[currentRoutes.length - <span class="hljs-number">1</span>]
            isLastRoute = lastRoute.handler.displayName <span class="hljs-keyword">is</span> <span class="hljs-property">@constructor</span>.displayName
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">'pushNewRoute'</span>, <span class="hljs-property">@toString</span>(), isLastRoute, lastRoute.name, oldRouteSpec?.toObj(), newRouteSpec?.toObj()

            <span class="hljs-keyword">if</span> isLastRoute <span class="hljs-keyword">and</span> lastRoute.name?
                newParams = newRouteSpec.get(<span class="hljs-string">'params'</span>)?.toObj() ? {}
                newQuery = newRouteSpec.get(<span class="hljs-string">'query'</span>)?.toObj() ? {}
                newStateDelta =
                    <span class="hljs-keyword">if</span> <span class="hljs-property">@stateFromRoute</span>?
                        J.util.withoutUndefined <span class="hljs-property">@stateFromRoute</span> newParams, newQuery
                    <span class="hljs-keyword">else</span>
                        {}

                oldStateFields = J.Dict()
                <span class="hljs-keyword">for</span> stateFieldName, stateFieldValue <span class="hljs-keyword">of</span> newStateDelta
                    oldStateFields.setOrAdd stateFieldName, <span class="hljs-property">@_canonicalState</span>[stateFieldName]

                newPath = <span class="hljs-property">@makeGoodPath</span> lastRoute.name, newParams, newQuery

                <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Old URI().resource: '</span>, URI().resource()

                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"oldStateFields"</span>, oldStateFields.toObj(), <span class="hljs-string">"newStateDelta"</span>, newStateDelta

                <span class="hljs-built_in">console</span>.log newPath, <span class="hljs-string">"different?"</span>, newPath <span class="hljs-keyword">isnt</span> URI().resource(), <span class="hljs-string">"push?"</span>, <span class="hljs-keyword">not</span> oldStateFields.deepEquals(newStateDelta)

                <span class="hljs-keyword">if</span> newPath <span class="hljs-keyword">isnt</span> URI().resource()
                    <span class="hljs-keyword">if</span> oldStateFields.deepEquals(newStateDelta)
                        ReactRouter.HistoryLocation.replace newPath
                    <span class="hljs-keyword">else</span>
                        ReactRouter.HistoryLocation.push newPath

        origOnChange = reactiveSpecByName.route.onChange
        <span class="hljs-keyword">if</span> origOnChange?
            reactiveSpecByName.route.onChange = <span class="hljs-function"><span class="hljs-params">(oldRouteSpec, newRouteSpec)</span> -&gt;</span>
                origOnChange.call @, oldRouteSpec, newRouteSpec
                pushNewRoute.call @, oldRouteSpec, newRouteSpec
        <span class="hljs-keyword">else</span>
            reactiveSpecByName.route.onChange = pushNewRoute

    <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> reactiveSpecByName
        <span class="hljs-keyword">if</span> reactiveName <span class="hljs-keyword">of</span> reactSpec
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Name conflict between <span class="hljs-subst">#{componentName}</span>.<span class="hljs-subst">#{reactiveName}</span> and
                <span class="hljs-subst">#{componentName}</span>.reactives.<span class="hljs-subst">#{reactiveName}</span>"</span>
        <span class="hljs-keyword">unless</span> _.isFunction(reactiveSpec.val)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{componentName}</span>.reactives.<span class="hljs-subst">#{reactiveName}</span> must have a val function"</span>

        reactSpec[reactiveName] = <span class="hljs-keyword">do</span> (reactiveName) -&gt; -&gt;
            <span class="hljs-property">@reactives</span>[reactiveName].get()


    reactSpec.getDefaultProps = <span class="hljs-function">-&gt;</span>
        defaultProps = {}
        <span class="hljs-keyword">for</span> propName, propSpec <span class="hljs-keyword">of</span> propSpecs
            defaultProps[propName] =
                <span class="hljs-keyword">if</span> <span class="hljs-string">'default'</span> <span class="hljs-keyword">of</span> propSpec
                    propSpec.<span class="hljs-reserved">default</span>
                <span class="hljs-keyword">else</span>
                    <span class="hljs-literal">null</span>
        defaultProps


    reactSpec.getInitialState = <span class="hljs-function">-&gt;</span>
        J.assert <span class="hljs-keyword">not</span> Tracker.active, <span class="hljs-string">"Can't initialize a component
            in a reactive computation: <span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>"</span>

        <span class="hljs-property">@_componentId</span> = J._nextComponentId
        J._nextComponentId += <span class="hljs-number">1</span>
        J._componentById[<span class="hljs-property">@_componentId</span>] = @
        J._componentsByName[componentName] ?= {}
        J._componentsByName[componentName][<span class="hljs-property">@_componentId</span>] = @

        <span class="hljs-property">@_valid</span> = J.Var <span class="hljs-literal">true</span>
        <span class="hljs-property">@_showingLoader</span> = <span class="hljs-literal">false</span>
        <span class="hljs-property">@_afterRenderCallbacks</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Check for invalid prop names in @props</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> propName, value <span class="hljs-keyword">of</span> <span class="hljs-property">@props</span>
            <span class="hljs-keyword">unless</span> propName <span class="hljs-keyword">of</span> propSpecs
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{componentName}</span> has no prop <span class="hljs-subst">#{JSON.stringify propName}</span>.
                    Only has <span class="hljs-subst">#{JSON.stringify _.keys propSpecs}</span>."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Set up @prop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_props</span> = {} <span class="hljs-comment"># Vars for the props</span>
        <span class="hljs-property">@_lazyProps</span> = {} <span class="hljs-comment"># Vars for the evaluated lazy props</span>
        <span class="hljs-property">@prop</span> = {} <span class="hljs-comment"># Reactive getters for the props</span>
        <span class="hljs-keyword">for</span> propName, propSpec <span class="hljs-keyword">of</span> propSpecs
            <span class="hljs-keyword">do</span> (propName, propSpec) =&gt;
                <span class="hljs-keyword">if</span> propName <span class="hljs-keyword">of</span> <span class="hljs-property">@props</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@props</span>[propName] <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Can't pass undefined <span class="hljs-subst">#{@}</span>.props.<span class="hljs-subst">#{propName}</span>"</span>

                initialValue = J.util.withoutUndefined <span class="hljs-property">@props</span>[propName]</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO: Validate type of initialValue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-property">@_props</span>[propName] = J.Var initialValue,
                    <span class="hljs-attribute">tag</span>:
                        <span class="hljs-attribute">component</span>: @
                        <span class="hljs-attribute">propName</span>: propName
                        <span class="hljs-attribute">tag</span>: <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.prop.<span class="hljs-subst">#{propName}</span>"</span>
                    <span class="hljs-attribute">equalsFunc</span>: <span class="hljs-function"><span class="hljs-params">(a, b)</span> =&gt;</span>
                        J.util.equals(a, b) <span class="hljs-keyword">or</span> (
                            (a <span class="hljs-keyword">instanceof</span> J.Dict <span class="hljs-keyword">or</span> a <span class="hljs-keyword">instanceof</span> J.List) <span class="hljs-keyword">and</span>
                            a.deepEquals(b)
                        )</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>@_lazyProps[propName] is a relatively heavy reactive computation that
we only need if there’s ever a time when prop laziness is used.
We also need it if there’s a propSpec.onChange, because the semantics
of onChange get tricky if and when they mix with laziness semantics.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">                <span class="hljs-title">setupLazyProp</span> = =&gt;</span>
                    <span class="hljs-property">@_lazyProps</span>[propName] = J.AutoVar(
                        (
                            <span class="hljs-attribute">component</span>: @
                            <span class="hljs-attribute">lazyPropName</span>: propName
                            <span class="hljs-attribute">tag</span>: <span class="hljs-string">"Lazy <span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.prop.<span class="hljs-subst">#{propName}</span>"</span>
                        )

                        =&gt;
                            propValue = <span class="hljs-property">@_props</span>[propName].get()

                            <span class="hljs-keyword">if</span> _.isFunction(propValue) <span class="hljs-keyword">and</span> propSpec.type <span class="hljs-keyword">isnt</span> $$.func
                                propValue.call @
                            <span class="hljs-keyword">else</span>
                                propValue

                        <span class="hljs-keyword">if</span> propSpec.onChange? <span class="hljs-keyword">then</span> (oldValue, newValue, isEarlyInitTime) =&gt;
                            <span class="hljs-keyword">if</span> oldValue <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isEarlyInitTime</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Since we have a hack to call all the onChange handlers early at component
init time, we need to stifle the onChange function called with the same arguments
again at afterFlush time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">return</span>

                            _pushDebugFlag propSpec.debug ? componentSpec.debug
                            <span class="hljs-keyword">if</span> componentDebug
                                <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"prop.<span class="hljs-subst">#{propName}</span>.onChange!
                                    <span class="hljs-subst">#{<span class="hljs-keyword">if</span> isEarlyInitTime <span class="hljs-keyword">then</span> <span class="hljs-string">'(early)'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span>"</span>
                                <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        old:"</span>, J.util.consolify oldValue
                                <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        new:"</span>, J.util.consolify newValue

                            propSpec.onChange?.call @, oldValue, newValue

                            _popDebugFlag()

                        <span class="hljs-attribute">creator</span>: <span class="hljs-literal">null</span>
                    )

                <span class="hljs-keyword">if</span> propSpec.onChange? <span class="hljs-keyword">then</span> setupLazyProp()

                <span class="hljs-property">@prop</span>[propName] = <span class="hljs-function">=&gt;</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-property">@_lazyProps</span>[propName]?
                        _pushDebugFlag propSpec.debug ? componentSpec.debug

                        <span class="hljs-keyword">try</span>
                            propValue = <span class="hljs-property">@_lazyProps</span>[propName].get()
                        <span class="hljs-keyword">catch</span> e
                            <span class="hljs-keyword">if</span> e <span class="hljs-keyword">instanceof</span> J.VALUE_NOT_READY
                                propValue = e
                            <span class="hljs-keyword">else</span>
                                <span class="hljs-keyword">throw</span> e

                        <span class="hljs-keyword">if</span> componentDebug
                            <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"prop.<span class="hljs-subst">#{propName}</span>()"</span>, propValue
                        _popDebugFlag()

                        <span class="hljs-keyword">if</span> propValue <span class="hljs-keyword">instanceof</span> J.VALUE_NOT_READY
                            <span class="hljs-keyword">throw</span> propValue
                        <span class="hljs-keyword">else</span>
                            <span class="hljs-keyword">return</span> propValue

                    propValue = <span class="hljs-property">@_props</span>[propName].get()

                    <span class="hljs-keyword">if</span> _.isFunction(propValue) <span class="hljs-keyword">and</span> propSpec.type <span class="hljs-keyword">isnt</span> $$.func
                        setupLazyProp()
                        <span class="hljs-property">@prop</span>[propName]()

                    <span class="hljs-keyword">else</span>
                        propValue</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set up @reactives
Note that stateFieldSpec.default functions can try calling reactives.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@reactives</span> = {} <span class="hljs-comment"># reactiveName: autoVar</span>
        <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> reactiveSpecByName
            <span class="hljs-property">@reactives</span>[reactiveName] = <span class="hljs-keyword">do</span> (reactiveName, reactiveSpec) =&gt;
                J.AutoVar(
                    (
                        <span class="hljs-attribute">component</span>: @
                        <span class="hljs-attribute">reactiveName</span>: reactiveName
                        <span class="hljs-attribute">tag</span>: <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.reactives.<span class="hljs-subst">#{reactiveName}</span>"</span>,
                    )

                    =&gt;
                        _pushDebugFlag reactiveSpec.debug ? componentSpec.debug
                        <span class="hljs-keyword">if</span> componentDebug
                            <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"!<span class="hljs-subst">#{reactiveName}</span>()"</span>
                            _debugDepth += <span class="hljs-number">1</span>

                        <span class="hljs-keyword">try</span>
                            retValue = reactiveSpec.val.call @
                        <span class="hljs-keyword">finally</span>
                            <span class="hljs-keyword">if</span> componentDebug
                                <span class="hljs-built_in">console</span>.debug _getDebugPrefix(), retValue
                                _debugDepth -= <span class="hljs-number">1</span>
                            _popDebugFlag()

                        retValue

                    <span class="hljs-keyword">if</span> _.isFunction reactiveSpec.onChange <span class="hljs-keyword">then</span> (oldValue, newValue, isEarlyInitTime) =&gt;
                        <span class="hljs-keyword">if</span> reactiveSpec.early <span class="hljs-keyword">and</span> oldValue <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isEarlyInitTime</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Since we have a hack to call all the onChange handlers early at component
init time, we need to stifle the onChange function called with the same arguments
again at afterFlush time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">return</span>

                        _pushDebugFlag reactiveSpec.debug ? componentSpec.debug
                        <span class="hljs-keyword">if</span> componentDebug
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"    <span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.<span class="hljs-subst">#{reactiveName}</span>.onChange!
                                <span class="hljs-subst">#{<span class="hljs-keyword">if</span> isEarlyInitTime <span class="hljs-keyword">then</span> <span class="hljs-string">'(early)'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span>"</span>
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        old:"</span>, J.util.consolify oldValue
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        new:"</span>, J.util.consolify newValue

                        reactiveSpec.onChange.call @, oldValue, newValue

                        _popDebugFlag()
                    <span class="hljs-keyword">else</span> reactiveSpec.onChange ? <span class="hljs-literal">null</span>

                    <span class="hljs-attribute">component</span>: @
                )</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Set up @state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialState = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Keep this around to implement stateFromRoute semantics</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_canonicalState</span> = {}

        <span class="hljs-keyword">for</span> stateFieldName, stateFieldSpec <span class="hljs-keyword">of</span> componentSpec.state
            <span class="hljs-keyword">if</span> _.isFunction(stateFieldSpec.<span class="hljs-reserved">default</span>) <span class="hljs-keyword">and</span> stateFieldSpec.type <span class="hljs-keyword">isnt</span> $$.func
                _pushDebugFlag stateFieldSpec.debug ? componentSpec.debug
                <span class="hljs-keyword">if</span> componentDebug
                    <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"<span class="hljs-subst">#{stateFieldName}</span> !default()"</span>
                    _debugDepth += <span class="hljs-number">1</span>

                initialValue = stateFieldSpec.<span class="hljs-reserved">default</span>.apply @

                <span class="hljs-keyword">if</span> componentDebug
                    <span class="hljs-built_in">console</span>.debug _getDebugPrefix(), initialValue
                    _debugDepth -= <span class="hljs-number">1</span>
                _popDebugFlag()
            <span class="hljs-keyword">else</span>
                initialValue = stateFieldSpec.<span class="hljs-reserved">default</span> ? <span class="hljs-literal">null</span>

            <span class="hljs-property">@_canonicalState</span>[stateFieldName] = initialValue

            initialState[stateFieldName] = J.Var initialValue,
                <span class="hljs-attribute">tag</span>:
                    <span class="hljs-attribute">component</span>: @
                    <span class="hljs-attribute">stateFieldName</span>: stateFieldName
                    <span class="hljs-attribute">tag</span>: <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.state.<span class="hljs-subst">#{stateFieldName}</span>"</span>
                <span class="hljs-attribute">onChange</span>: <span class="hljs-keyword">if</span> stateFieldSpec.onChange? <span class="hljs-keyword">then</span> <span class="hljs-keyword">do</span> (stateFieldName, stateFieldSpec) =&gt;
                    (oldValue, newValue, isEarlyInitTime) =&gt;
                        _pushDebugFlag stateFieldSpec.debug ? componentSpec.debug
                        <span class="hljs-keyword">if</span> componentDebug
                            <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"state.<span class="hljs-subst">#{stateFieldName}</span>.onChange!
                                <span class="hljs-subst">#{<span class="hljs-keyword">if</span> isEarlyInitTime <span class="hljs-keyword">then</span> <span class="hljs-string">'(early)'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span>"</span>
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        old:"</span>, J.util.consolify oldValue
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"        new:"</span>, J.util.consolify newValue

                        stateFieldSpec.onChange.call @, oldValue, newValue

                        _popDebugFlag()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This is what React is going to do after this function returns, but we need
to do it early because of the synchronous onChanges.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@state</span> = initialState</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Call all the onChange handlers synchronously because they might initialize
the state during a cascading React render thread.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> lazyPropName, lazyPropAutoVar <span class="hljs-keyword">of</span> <span class="hljs-property">@_lazyProps</span>
            lazyPropValue = lazyPropAutoVar.get()
            <span class="hljs-keyword">if</span> _.isFunction lazyPropAutoVar.onChange
                lazyPropAutoVar.onChange <span class="hljs-literal">undefined</span>, lazyPropValue, <span class="hljs-literal">true</span>
        <span class="hljs-keyword">for</span> reactiveName, reactiveAutoVar <span class="hljs-keyword">of</span> <span class="hljs-property">@reactives</span>
            reactiveSpec = reactiveSpecByName[reactiveName]
            <span class="hljs-keyword">if</span> reactiveSpec.early
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> reactiveAutoVar.onChange?
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"AutoVar is set to early but has no onChange value"</span>
                reactiveValue = reactiveAutoVar.get()
                <span class="hljs-keyword">if</span> _.isFunction reactiveAutoVar.onChange
                    reactiveAutoVar.onChange <span class="hljs-literal">undefined</span>, reactiveValue, <span class="hljs-literal">true</span>
        <span class="hljs-keyword">for</span> stateFieldName, stateVar <span class="hljs-keyword">of</span> <span class="hljs-property">@state</span>
            stateVar.onChange? <span class="hljs-literal">undefined</span>, stateVar._value, <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return initialState to React</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialState


    reactSpec.set = <span class="hljs-function"><span class="hljs-params">(stateFields, callback)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> callback? <span class="hljs-keyword">then</span> <span class="hljs-property">@afterRender</span> callback

        <span class="hljs-keyword">for</span> stateFieldName, value <span class="hljs-keyword">of</span> stateFields
            <span class="hljs-keyword">unless</span> stateFieldName <span class="hljs-keyword">of</span> <span class="hljs-property">@state</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"<span class="hljs-subst">#{componentName}</span>.state.<span class="hljs-subst">#{stateFieldName}</span> does not exist."</span>
            <span class="hljs-property">@state</span>[stateFieldName].set value

        <span class="hljs-literal">null</span>


    reactSpec.componentWillReceiveProps = <span class="hljs-function"><span class="hljs-params">(nextProps)</span> -&gt;</span>
        componentSpec.componentWillReceiveProps?.call @, nextProps

        <span class="hljs-keyword">for</span> propName, newValue <span class="hljs-keyword">of</span> nextProps
            <span class="hljs-property">@_props</span>[propName].set J.util.withoutUndefined newValue


    reactSpec.componentDidMount = <span class="hljs-function">-&gt;</span>
        J._componentDomById[<span class="hljs-property">@_componentId</span>] = <span class="hljs-property">@getDOMNode</span>()
        J._componentDomsByName[componentName] ?= {}
        J._componentDomsByName[componentName][<span class="hljs-property">@_componentId</span>] = <span class="hljs-property">@getDOMNode</span>()

        componentSpec.componentDidMount?.apply @

        <span class="hljs-property">@_doAfterRender</span>()


    reactSpec._doAfterRender = <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@_showingLoader</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@_valid</span>.get()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Will try again after render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span>

        prevAfterRenderCallbacks = <span class="hljs-property">@_afterRenderCallbacks</span> ? []
        <span class="hljs-property">@_afterRenderCallbacks</span> = []
        callback() <span class="hljs-keyword">for</span> callback <span class="hljs-keyword">in</span> prevAfterRenderCallbacks


    reactSpec.shouldComponentUpdate = <span class="hljs-function"><span class="hljs-params">(nextProps, nextState)</span> -&gt;</span>
        <span class="hljs-keyword">not</span> <span class="hljs-property">@_elementVar</span>? <span class="hljs-keyword">or</span> <span class="hljs-property">@_elementVar</span>.invalidated


    reactSpec.componentDidUpdate = <span class="hljs-function"><span class="hljs-params">(prevProps, prevState)</span> -&gt;</span>
        <span class="hljs-property">@_doAfterRender</span>()

        componentSpec.componentDidUpdate?.call @


    reactSpec.afterRender = <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span>
        J.assert <span class="hljs-keyword">not</span> Tracker.active <span class="hljs-keyword">or</span> <span class="hljs-property">@_elementVar</span>?._getting, <span class="hljs-string">"Can only call afterRender
            from within render function or from outside a reactive computation."</span>

        <span class="hljs-property">@_afterRenderCallbacks</span>.push f
        Tracker.afterFlush(
            <span class="hljs-function">=&gt;</span> <span class="hljs-property">@_doAfterRender</span>()
            Number.POSITIVE_INFINITY
        )
        <span class="hljs-literal">null</span>


    reactSpec.componentWillUnmount = <span class="hljs-function">-&gt;</span>
        componentSpec.componentWillUnmount?.apply @

        <span class="hljs-keyword">delete</span> J._componentById[<span class="hljs-property">@_componentId</span>]
        <span class="hljs-keyword">delete</span> J._componentDomById[<span class="hljs-property">@_componentId</span>]
        <span class="hljs-keyword">delete</span> J._componentsByName[componentName][<span class="hljs-property">@_componentId</span>]
        <span class="hljs-keyword">delete</span> J._componentDomsByName[componentName][<span class="hljs-property">@_componentId</span>]

        <span class="hljs-property">@_valid</span>.set <span class="hljs-literal">false</span>
        <span class="hljs-property">@_elementVar</span>.stop()

        J.fetching._deleteComputationQsRequests <span class="hljs-property">@_elementVar</span>
        <span class="hljs-keyword">for</span> lazyPropName, lazyPropVar <span class="hljs-keyword">of</span> <span class="hljs-property">@_lazyProps</span>
            lazyPropVar.stop()
        <span class="hljs-keyword">for</span> reactiveName, reactiveVar <span class="hljs-keyword">of</span> <span class="hljs-property">@reactives</span>
            reactiveVar.stop()</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Garbage collector seems to need this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">delete</span> <span class="hljs-property">@_elementVar</span>.component
        <span class="hljs-keyword">delete</span> <span class="hljs-property">@_elementVar</span>


    reactSpec._hasInvalidAncestor = <span class="hljs-function">-&gt;</span>
        ancestor = @
        <span class="hljs-keyword">while</span> ancestor
            <span class="hljs-keyword">if</span> ancestor._valid? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ancestor._valid.get()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            ancestor = ancestor._owner
        <span class="hljs-literal">false</span>


    reactSpec.tryGet = <span class="hljs-function"><span class="hljs-params">(reactiveName, defaultValue)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> reactiveName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> <span class="hljs-property">@reactives</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid reactive name: <span class="hljs-subst">#{@}</span>.<span class="hljs-subst">#{reactiveName}</span>"</span>

        <span class="hljs-property">@reactives</span>[reactiveName].tryGet defaultValue


    reactSpec.tryGetProp = <span class="hljs-function"><span class="hljs-params">(propName, defaultValue)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> propName <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> <span class="hljs-property">@_props</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid prop name: <span class="hljs-subst">#{@}</span>.<span class="hljs-subst">#{propName}</span>"</span>

        J.tryGet <span class="hljs-property">@prop</span>[propName], defaultValue


    reactSpec.renderLoader ?= <span class="hljs-function">-&gt;</span>
        $$ (<span class="hljs-string">'div'</span>),
            <span class="hljs-attribute">style</span>:
                <span class="hljs-attribute">textAlign</span>: <span class="hljs-string">'center'</span>
                <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>
            $$ (<span class="hljs-string">'Loader'</span>)


    reactSpec.render = <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">if</span> Tracker.active
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Can't call render inside a reactive computation: <span class="hljs-subst">#{Tracker.currentComputation._id}</span>"</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@_elementVar</span>? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@_elementVar</span>.invalidated
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Called <span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.forceUpdate() - J.components
                don't allow forceUpdate(). Use reactive expressions instead."</span>

        _pushDebugFlag componentSpec.debug
        <span class="hljs-keyword">if</span> componentDebug
            <span class="hljs-built_in">console</span>.debug _getDebugPrefix(@), <span class="hljs-string">"render!"</span>
            _debugDepth += <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@_elementVar</span>?
            <span class="hljs-property">@_elementVar</span>.stop()
            J.fetching._deleteComputationQsRequests <span class="hljs-property">@_elementVar</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>First render
Pre-compute all the reactives with onChanges in parallel. This is
so we won’t waste time fetching data in series when render needs it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> reactiveName, reactive <span class="hljs-keyword">of</span> <span class="hljs-property">@reactives</span>
                    <span class="hljs-keyword">if</span> reactive.onChange
                        <span class="hljs-keyword">if</span> componentDebug
                            <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"Precomputing !<span class="hljs-subst">#{reactiveName}</span>"</span>
                        reactive.tryGet()

        firstRun = <span class="hljs-literal">true</span>
        <span class="hljs-property">@_elementVar</span> = J.AutoVar(
            (
                <span class="hljs-attribute">component</span>: @
                <span class="hljs-attribute">tag</span>: <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@toString</span>()}</span>.render"</span>
            )

            (elementVar) =&gt;
                <span class="hljs-keyword">if</span> firstRun
                    firstRun = <span class="hljs-literal">false</span>
                    Tracker.onInvalidate =&gt; <span class="hljs-property">@_valid</span>.set <span class="hljs-literal">false</span>

                    <span class="hljs-keyword">if</span> J.Routable <span class="hljs-keyword">in</span> (componentSpec.mixins ? [])</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If the URL changes, that will cause all the Routable
components to need to be re-rendered. Otherwise
shouldComponentUpdate will block ReactRouter functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        J._urlVar.get()

                    unpackRenderSpec componentSpec.render.apply @

                <span class="hljs-keyword">else</span>
                    elementVar.stop()

                    Tracker.afterFlush(
                        <span class="hljs-function">=&gt;</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-property">@_elementVar</span> <span class="hljs-keyword">is</span> elementVar <span class="hljs-keyword">and</span> <span class="hljs-property">@isMounted</span>()
                                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (<span class="hljs-property">@_owner</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@_owner</span>._hasInvalidAncestor?())
                                    <span class="hljs-property">@forceUpdate</span>()
                        <span class="hljs-property">@_componentId</span> + <span class="hljs-number">10</span>
                    )

                    <span class="hljs-literal">null</span>

            <span class="hljs-literal">null</span>

            <span class="hljs-attribute">component</span>: @
            <span class="hljs-attribute">sortKey</span>: <span class="hljs-property">@_componentId</span> + <span class="hljs-number">10</span>
        )

        <span class="hljs-property">@_valid</span>.set <span class="hljs-literal">true</span>

        element = <span class="hljs-property">@_elementVar</span>.tryGet()

        <span class="hljs-keyword">if</span> componentDebug
            <span class="hljs-built_in">console</span>.debug _getDebugPrefix(), <span class="hljs-keyword">if</span> element? <span class="hljs-keyword">then</span> <span class="hljs-string">"[Rendered <span class="hljs-subst">#{@}</span>]"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"[Loader for <span class="hljs-subst">#{@}</span>]"</span>
            _debugDepth -= <span class="hljs-number">1</span>
        _popDebugFlag()

        <span class="hljs-keyword">if</span> element <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
            <span class="hljs-property">@_showingLoader</span> = <span class="hljs-literal">true</span>
            <span class="hljs-property">@renderLoader</span>()
        <span class="hljs-keyword">else</span>
            <span class="hljs-property">@_showingLoader</span> = <span class="hljs-literal">false</span>
            element


    reactSpec.toString = <span class="hljs-function">-&gt;</span>
        <span class="hljs-string">"&lt;<span class="hljs-subst">#{componentName}</span>-<span class="hljs-subst">#{<span class="hljs-property">@_componentId</span>}</span>&gt;"</span>


    J.components[componentName] = React.createClass reactSpec
<span class="hljs-function">

<span class="hljs-title">$$</span> = <span class="hljs-params">(elemType, props, children...)</span> -&gt;</span>
    args = Array.prototype.slice.call arguments

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> elemType[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">and</span> elemType[<span class="hljs-number">0</span>].toUpperCase() <span class="hljs-keyword">is</span> elemType[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"No component class <span class="hljs-subst">#{elemType}</span>."</span> <span class="hljs-keyword">unless</span> elemType <span class="hljs-keyword">of</span> J.components
        args[<span class="hljs-number">0</span>] = J.components[elemType]

    React.createElement.apply React, args


J.lazy = <span class="hljs-function"><span class="hljs-params">(childrenFunc)</span> -&gt;</span>
    componentName = <span class="hljs-string">"_Lazy<span class="hljs-subst">#{J.getNextId()}</span>"</span>

    J._defineComponent componentName,
        <span class="hljs-attribute">_isLazy</span>: <span class="hljs-literal">true</span>

        <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
            childrenFunc() ? <span class="hljs-literal">null</span>

    $$ (componentName)


Meteor.startup -&gt;
    <span class="hljs-keyword">for</span> componentDef <span class="hljs-keyword">in</span> componentDefinitionQueue
        J._defineComponent componentDef.name, componentDef.spec

    componentDefinitionQueue = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="http://fuelyourcoding.com/scripts/toc/js/jquery.tableofcontents.min.js"></script>
  <script>
    $(function () {
      $("h1").first().after("<ul id='toc'>").after("<hr>");
      $("#toc").after("<hr>").tableOfContents(null, {
        startLevel: 2,
        depth: 10
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>

<html>
<head>
  <title>publish.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="autodict.html">
                  autodict.coffee
                </a>
              
                
                <a class="source" href="autolist.html">
                  autolist.coffee
                </a>
              
                
                <a class="source" href="autovar.html">
                  autovar.coffee
                </a>
              
                
                <a class="source" href="components.html">
                  components.coffee
                </a>
              
                
                <a class="source" href="AreYouSure.html">
                  AreYouSure.coffee
                </a>
              
                
                <a class="source" href="Button.html">
                  Button.coffee
                </a>
              
                
                <a class="source" href="CancelButton.html">
                  CancelButton.coffee
                </a>
              
                
                <a class="source" href="DeleteButton.html">
                  DeleteButton.coffee
                </a>
              
                
                <a class="source" href="Dropdown.html">
                  Dropdown.coffee
                </a>
              
                
                <a class="source" href="EditButton.html">
                  EditButton.coffee
                </a>
              
                
                <a class="source" href="Expandable.html">
                  Expandable.coffee
                </a>
              
                
                <a class="source" href="KeyValueTable.html">
                  KeyValueTable.coffee
                </a>
              
                
                <a class="source" href="LinkButton.html">
                  LinkButton.coffee
                </a>
              
                
                <a class="source" href="Loader.html">
                  Loader.coffee
                </a>
              
                
                <a class="source" href="SubmitCancelDelete.html">
                  SubmitCancelDelete.coffee
                </a>
              
                
                <a class="source" href="TableRow.html">
                  TableRow.coffee
                </a>
              
                
                <a class="source" href="TextBox.html">
                  TextBox.coffee
                </a>
              
                
                <a class="source" href="denorm.html">
                  denorm.coffee
                </a>
              
                
                <a class="source" href="dict.html">
                  dict.coffee
                </a>
              
                
                <a class="source" href="dom.html">
                  dom.coffee
                </a>
              
                
                <a class="source" href="BooksDemo.html">
                  BooksDemo.coffee
                </a>
              
                
                <a class="source" href="SampleData.html">
                  SampleData.coffee
                </a>
              
                
                <a class="source" href="BatteryApi.html">
                  BatteryApi.coffee
                </a>
              
                
                <a class="source" href="ChatRoom.html">
                  ChatRoom.coffee
                </a>
              
                
                <a class="source" href="Home.html">
                  Home.coffee
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.coffee
                </a>
              
                
                <a class="source" href="NotFound.html">
                  NotFound.coffee
                </a>
              
                
                <a class="source" href="chat.html">
                  chat.coffee
                </a>
              
                
                <a class="source" href="routes.html">
                  routes.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="fetching.html">
                  fetching.coffee
                </a>
              
                
                <a class="source" href="j.html">
                  j.coffee
                </a>
              
                
                <a class="source" href="list.html">
                  list.coffee
                </a>
              
                
                <a class="source" href="models.html">
                  models.coffee
                </a>
              
                
                <a class="source" href="proptypes.html">
                  proptypes.coffee
                </a>
              
                
                <a class="source" href="publish.html">
                  publish.coffee
                </a>
              
                
                <a class="source" href="routing.html">
                  routing.coffee
                </a>
              
                
                <a class="source" href="autovar-tests.html">
                  autovar-tests.coffee
                </a>
              
                
                <a class="source" href="denorm-tests.html">
                  denorm-tests.coffee
                </a>
              
                
                <a class="source" href="dict-tests.html">
                  dict-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-client-tests.html">
                  jframework-client-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-tests.html">
                  jframework-tests.coffee
                </a>
              
                
                <a class="source" href="list-tests.html">
                  list-tests.coffee
                </a>
              
                
                <a class="source" href="publish-tests.html">
                  publish-tests.coffee
                </a>
              
                
                <a class="source" href="test-models.html">
                  test-models.coffee
                </a>
              
                
                <a class="source" href="util-tests.html">
                  util-tests.coffee
                </a>
              
                
                <a class="source" href="tracker.html">
                  tracker.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="var.html">
                  var.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>publish.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015, Quixey Inc.
All rights reserved.</p>
<p>Licensed under the Modified BSD License found in the
LICENSE file in the root directory of this source tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
J.defineModel <span class="hljs-string">'JDataSession'</span>, <span class="hljs-string">'jframework_datasessions'</span>,
    <span class="hljs-attribute">_id</span>: $$.str

    <span class="hljs-attribute">fields</span>:
        <span class="hljs-attribute">querySpecStrings</span>:
            <span class="hljs-attribute">type</span>: $$.arr


Fiber = Npm.<span class="hljs-built_in">require</span> <span class="hljs-string">'fibers'</span>

J._inMethod = <span class="hljs-keyword">new</span> Meteor.EnvironmentVariable

J.methods = <span class="hljs-function"><span class="hljs-params">(methods)</span> -&gt;</span>
    wrappedMethods = {}
    <span class="hljs-keyword">for</span> methodName, methodFunc <span class="hljs-keyword">of</span> methods
        <span class="hljs-keyword">do</span> (methodName, methodFunc) -&gt;
            wrappedMethods[methodName] = <span class="hljs-function">-&gt;</span>
                args = arguments
                J._inMethod.withValue <span class="hljs-literal">true</span>, <span class="hljs-function">=&gt;</span>
                    methodFunc.apply @, args

    Meteor.methods wrappedMethods</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>JSON.stringify([modelName, instanceId, reactiveName]): true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>J._recalcBuffer = {}
_willFlush = <span class="hljs-literal">false</span>
<span class="hljs-function"><span class="hljs-title">_addRecalcBufferKey</span> = <span class="hljs-params">(bufferKey)</span> -&gt;</span>
    J._recalcBuffer[bufferKey] = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _willFlush
        _willFlush = <span class="hljs-literal">true</span>
        Meteor.defer -&gt;
            _flushRecalcBuffer()
            _willFlush = <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">_flushRecalcBuffer</span> = -&gt;</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> _.isEmpty J._recalcBuffer
        bufferKey = _.keys(J._recalcBuffer)[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">delete</span> J._recalcBuffer[bufferKey]

        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"RECALC: <span class="hljs-subst">#{bufferKey}</span>"</span>

        [modelName, instanceId, reactiveName] = JSON.parse bufferKey
        modelClass = J.models[modelName]
        instance = modelClass.fetchOne instanceId
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> instance?
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Can't denorm <span class="hljs-subst">#{bufferKey}</span>: instance no longer exists"</span>
            <span class="hljs-keyword">return</span>

        J.denorm.recalc instance, reactiveName</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>dataSessionId: J.Dict
    updateObserversFiber: <Fiber>
    querySpecSet: {qsString: true}
    mergedQuerySpecs: [
        {
            modelName:
            selector:
            fields:
            sort:
            skip:
            limit:
        }
    ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>dataSessions = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Stores Meteor’s publisher functions
sessionId:
    userId
    added
    changed
    removed
    …etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>dataSessionPublisherContexts = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The set of active cursors and exactly what each has sent to the client
dataSessionId: modelName: docId: fieldName: querySpecString: value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>dataSessionFieldsByModelIdQuery = {}


Meteor.methods
    <span class="hljs-attribute">_updateDataQueries</span>: <span class="hljs-function"><span class="hljs-params">(dataSessionId, addedQuerySpecs, deletedQuerySpecs)</span> -&gt;</span>
<span class="hljs-function">        <span class="hljs-title">log</span> = -&gt;</span>
            newArgs = [<span class="hljs-string">"[<span class="hljs-subst">#{dataSessionId}</span>]"</span>].concat _.toArray arguments
            <span class="hljs-built_in">console</span>.log.apply <span class="hljs-built_in">console</span>, newArgs

        log <span class="hljs-string">'_updateDataQueries'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <pre><code>   <span class="hljs-keyword">if</span> addedQuerySpecs.length
       log <span class="hljs-string">'    added:'</span>, J.util.stringify qs <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> addedQuerySpecs
   <span class="hljs-keyword">if</span> deletedQuerySpecs.length
       log <span class="hljs-string">'    deleted:'</span>, J.util.stringify qs <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> deletedQuerySpecs
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
        session = dataSessions[dataSessionId]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session?
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"Data session not found"</span>, dataSessionId
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Data session not found: <span class="hljs-subst">#{JSON.stringify dataSessionId}</span>"</span>

        <span class="hljs-keyword">for</span> querySpec <span class="hljs-keyword">in</span> addedQuerySpecs
            <span class="hljs-keyword">unless</span> querySpec.modelName <span class="hljs-keyword">of</span> J.models
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid modelName in querySpec:
                    <span class="hljs-subst">#{J.util.toString querySpec}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Apply the diff to session.querySpecSet()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        actualAdded = []
        actualDeleted = []
        <span class="hljs-keyword">for</span> querySpec <span class="hljs-keyword">in</span> deletedQuerySpecs
            qsString = J.fetching.stringifyQs querySpec
            <span class="hljs-keyword">if</span> session.querySpecSet().hasKey(qsString)
                actualDeleted.push querySpec
                session.querySpecSet().<span class="hljs-keyword">delete</span> qsString
        <span class="hljs-keyword">for</span> querySpec <span class="hljs-keyword">in</span> addedQuerySpecs
            qsString = J.fetching.stringifyQs querySpec
            <span class="hljs-keyword">unless</span> session.querySpecSet().hasKey(qsString)
                actualAdded.push qsString
                session.querySpecSet().setOrAdd qsString, <span class="hljs-literal">true</span>

        Tracker.flush()

        session.updateObserversFiber = Fiber.current
        updateObservers.call dataSessionPublisherContexts[dataSessionId], dataSessionId
        session.updateObserversFiber = <span class="hljs-literal">null</span>

        jDataSession = <span class="hljs-keyword">new</span> $$.JDataSession
            <span class="hljs-attribute">_id</span>: dataSessionId
            <span class="hljs-attribute">querySpecStrings</span>: session.querySpecSet().getKeys()
        jDataSession.save()</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>log ‘…_updateDataQueries done’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

Meteor.publish <span class="hljs-string">'_jdata'</span>, <span class="hljs-function"><span class="hljs-params">(dataSessionId)</span> -&gt;</span>
    check dataSessionId, String
<span class="hljs-function">
    <span class="hljs-title">log</span> = -&gt;</span>
        newArgs = [<span class="hljs-string">"[<span class="hljs-subst">#{dataSessionId}</span>]"</span>].concat _.toArray arguments
        <span class="hljs-built_in">console</span>.log.apply <span class="hljs-built_in">console</span>, newArgs

    log <span class="hljs-string">'publish _jdata'</span>

    session = dataSessions[dataSessionId] = J.AutoDict(
        <span class="hljs-string">"dataSessions[<span class="hljs-subst">#{dataSessionId}</span>]"</span>

        <span class="hljs-attribute">querySpecSet</span>: J.Dict() <span class="hljs-comment"># qsString: true</span>

        <span class="hljs-attribute">mergedQuerySpecs</span>: <span class="hljs-function">=&gt;</span> getMergedQuerySpecs session.querySpecSet()

        <span class="hljs-attribute">observerByQsString</span>: J.Dict()
    )
    dataSessionPublisherContexts[dataSessionId] = @
    dataSessionFieldsByModelIdQuery[dataSessionId] = {}

    existingSessionInstance = $$.JDataSession.fetchOne dataSessionId
    <span class="hljs-keyword">if</span> existingSessionInstance?
        existingQuerySpecs = existingSessionInstance.querySpecStrings().map(
            <span class="hljs-function"><span class="hljs-params">(querySpecString)</span> =&gt;</span> J.fetching.parseQs querySpecString
        ).toArr()
        Meteor.call <span class="hljs-string">'_updateDataQueries'</span>, dataSessionId, existingQuerySpecs, []

    <span class="hljs-property">@onStop</span> =&gt;
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[<span class="hljs-subst">#{dataSessionId}</span>] PUBLISHER STOPPED"</span>
        session.stop()

        <span class="hljs-keyword">if</span> session.updateObserversFiber?
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"Uh oh, we were in the middle of updating observers."</span>
            session.updateObserversFiber.reset()

        <span class="hljs-keyword">delete</span> dataSessionFieldsByModelIdQuery[dataSessionId]
        <span class="hljs-keyword">delete</span> dataSessionPublisherContexts[dataSessionId]
        <span class="hljs-keyword">delete</span> dataSessions[dataSessionId]
        $$.JDataSession.remove dataSessionId

    <span class="hljs-property">@ready</span>()
<span class="hljs-function">

<span class="hljs-title">getMergedQuerySpecs</span> = <span class="hljs-params">(querySpecSet)</span> =&gt;</span>
    mergedQuerySpecs = J.List()
    querySpecSet.forEach (rawQsString) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>TODO: Fancier merge stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rawQuerySpec = J.fetching.parseQs rawQsString
        mergedQuerySpecs.push rawQuerySpec
    mergedQuerySpecs
<span class="hljs-function">

<span class="hljs-title">updateObservers</span> = <span class="hljs-params">(dataSessionId)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">log</span> = -&gt;</span>
        newArgs = [<span class="hljs-string">"[<span class="hljs-subst">#{dataSessionId}</span>]"</span>].concat _.toArray arguments
        <span class="hljs-built_in">console</span>.log.apply <span class="hljs-built_in">console</span>, newArgs</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>log “Update observers”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    session = dataSessions[dataSessionId]

    oldQsStrings = session.observerByQsString().getKeys()
    newQsStrings = session.mergedQuerySpecs().map(
        <span class="hljs-function"><span class="hljs-params">(qs)</span> =&gt;</span> J.fetching.stringifyQs qs.toObj()
    ).toArr()
    qsStringsDiff = J.util.diffStrings oldQsStrings, newQsStrings</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>console.log “qsStringsDiff”, qsStringsDiff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    fieldsByModelIdQuery = dataSessionFieldsByModelIdQuery[dataSessionId]
<span class="hljs-function">
    
    <span class="hljs-title">getMergedSubfields</span> = <span class="hljs-params">(a, b)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> a <span class="hljs-keyword">if</span> b <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">return</span> b <span class="hljs-keyword">if</span> a <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>

        <span class="hljs-keyword">if</span> J.util.isPlainObject(a) <span class="hljs-keyword">and</span> J.util.isPlainObject(b)
            keySet = {}
            keySet[key] = <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> a
            keySet[key] = <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> b
            ret = {}
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> keySet
                ret[key] = getMergedSubfields a[key], b[key]
            ret
        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>It’s possible that a != b (by value) right now because
one cursor is triggering an observer for an updated value
right before all the other cursors are going to trigger
observers for the same updated value. It’s fine to just
arbitrarily pick (a) and let the merge become eventually
consistent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            a
<span class="hljs-function">

    <span class="hljs-title">getField</span> = <span class="hljs-params">(modelName, id, fieldName)</span> -&gt;</span>
        fieldValueByQsString = fieldsByModelIdQuery[modelName][id][fieldName] ? {}
        _.values(fieldValueByQsString).reduce getMergedSubfields, <span class="hljs-literal">undefined</span>
<span class="hljs-function">

    <span class="hljs-title">setField</span> = <span class="hljs-params">(modelName, id, fieldName, querySpec, value)</span> -&gt;</span>
        modelClass = J.models[modelName]
        qsString = J.fetching.stringifyQs querySpec
        fieldsByModelIdQuery[modelName][id][fieldName] ?= {}

        <span class="hljs-keyword">if</span> fieldName <span class="hljs-keyword">is</span> <span class="hljs-string">'_reactives'</span>
            reactivesObj = JSON.parse(JSON.stringify(value ? {}))
            fieldsByModelIdQuery[modelName][id][fieldName][qsString] = reactivesObj

            instance = <span class="hljs-literal">undefined</span>

            <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
                included = <span class="hljs-literal">false</span>

                <span class="hljs-keyword">if</span> reactiveSpec.denorm
                    <span class="hljs-keyword">for</span> fieldOrReactiveSpec <span class="hljs-keyword">of</span> querySpec.fields ? {}
                        <span class="hljs-keyword">if</span> fieldOrReactiveSpec.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> reactiveName
                            included = <span class="hljs-literal">true</span>
                            <span class="hljs-keyword">break</span>

                <span class="hljs-keyword">if</span> included <span class="hljs-keyword">and</span> reactivesObj[reactiveName]?.val <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
                    SYNC_RECALC = <span class="hljs-literal">true</span>
                    <span class="hljs-keyword">if</span> SYNC_RECALC
                        reactivesObj[reactiveName] ?= {}
                        instance ?= modelClass.fetchOne id
                        <span class="hljs-keyword">if</span> instance?</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Instance might not exist because the instance might have been
deleted while we’re still catching up publishing an @added or @changed
that includes a reactive.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            reactivesObj[reactiveName].val = J.denorm.recalc instance, reactiveName

                    <span class="hljs-keyword">else</span>
                        bufferKey = JSON.stringify [modelName, id, reactiveName]
                        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"<span class="hljs-subst">#{JSON.stringify querySpec}</span> &lt;&lt;&lt; deferring recalc of <span class="hljs-subst">#{reactiveName}</span>
                            <span class="hljs-subst">#{<span class="hljs-keyword">if</span> bufferKey <span class="hljs-keyword">of</span> J._recalcBuffer <span class="hljs-keyword">then</span> <span class="hljs-string">'(redundant)'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span>"</span>

                        _addRecalcBufferKey bufferKey

        <span class="hljs-keyword">else</span>
            fieldsByModelIdQuery[modelName][id][fieldName][qsString] = value


    qsStringsDiff.added.forEach (qsString) =&gt;
        querySpec = J.fetching.parseQs qsString</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>log “Add observer for: “, querySpec</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        modelClass = J.models[querySpec.modelName]

        mongoOptions = {}
        <span class="hljs-keyword">for</span> optionName <span class="hljs-keyword">in</span> [<span class="hljs-string">'sort'</span>, <span class="hljs-string">'skip'</span>, <span class="hljs-string">'limit'</span>]
            <span class="hljs-keyword">if</span> querySpec[optionName]?
                mongoOptions[optionName] = querySpec[optionName]

        mongoOptions.fields = J.fetching.projectionToMongoFieldsArg modelClass, querySpec.fields ? {}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>log ‘mongoOptions.fields: ‘, JSON.stringify mongoOptions.fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        cursor = modelClass.collection.find querySpec.selector, mongoOptions

        observer = cursor.observeChanges
            <span class="hljs-attribute">added</span>: <span class="hljs-function"><span class="hljs-params">(id, fields)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>log querySpec, “server says ADDED:”, id, fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                fields = _.clone fields
                fields._reactives ?= {}

                <span class="hljs-keyword">if</span> id <span class="hljs-keyword">of</span> (fieldsByModelIdQuery?[querySpec.modelName] ? {})</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>The set of projections being watched on this doc may have grown.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    changedFields = {}

                    <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> fields
                        oldValue = getField querySpec.modelName, id, fieldName
                        setField querySpec.modelName, id, fieldName, querySpec, value
                        newValue = getField querySpec.modelName, id, fieldName
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> EJSON.equals oldValue, newValue
                            changedFields[fieldName] = newValue

                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isEmpty changedFields</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>log querySpec, “sending CHANGED:”, id, changedFields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-property">@changed</span> modelClass.collection._name, id, changedFields

                <span class="hljs-keyword">else</span>
                    fieldsByModelIdQuery[querySpec.modelName] ?= {}
                    fieldsByModelIdQuery[querySpec.modelName][id] ?= {}

                    changedFields = {}

                    <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> fields
                        setField querySpec.modelName, id, fieldName, querySpec, value
                        changedFields[fieldName] = getField querySpec.modelName, id, fieldName</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>log querySpec, “sending ADDED:”, id, changedFields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-property">@added</span> modelClass.collection._name, id, changedFields

            <span class="hljs-attribute">changed</span>: <span class="hljs-function"><span class="hljs-params">(id, fields)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>log querySpec, “server says CHANGED:”, id, fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                fields = _.clone fields
                fields._reactives ?= {}

                changedFields = {}

                <span class="hljs-keyword">for</span> fieldName, value <span class="hljs-keyword">of</span> fields
                    oldValue = getField querySpec.modelName, id, fieldName
                    setField querySpec.modelName, id, fieldName, querySpec, value
                    newValue = getField querySpec.modelName, id, fieldName
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> EJSON.equals oldValue, newValue
                        changedFields[fieldName] = newValue

                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isEmpty changedFields</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>log querySpec, “sending CHANGED:”, id, changedFields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-property">@changed</span> modelClass.collection._name, id, changedFields

            <span class="hljs-attribute">removed</span>: <span class="hljs-function"><span class="hljs-params">(id)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>log querySpec, “server says REMOVED:”, id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                changedFields = {}

                <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">in</span> _.keys fieldsByModelIdQuery[querySpec.modelName][id]
                    oldValue = getField querySpec.modelName, id, fieldName
                    <span class="hljs-keyword">delete</span> fieldsByModelIdQuery[querySpec.modelName][id][fieldName][qsString]
                    newValue = getField querySpec.modelName, id, fieldName
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> EJSON.equals oldValue, newValue
                        changedFields[fieldName] = newValue
                    <span class="hljs-keyword">if</span> _.isEmpty fieldsByModelIdQuery[querySpec.modelName][id][fieldName]
                        <span class="hljs-keyword">delete</span> fieldsByModelIdQuery[querySpec.modelName][id][fieldName]

                <span class="hljs-keyword">if</span> _.isEmpty fieldsByModelIdQuery[querySpec.modelName][id]
                    <span class="hljs-keyword">delete</span> fieldsByModelIdQuery[querySpec.modelName][id]</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>log querySpec, “sending REMOVED:”, id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-property">@removed</span> modelClass.collection._name, id
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isEmpty changedFields</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>log querySpec, “sending CHANGED:”, id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-property">@changed</span> modelClass.collection._name, id, changedFields

        session.observerByQsString().setOrAdd qsString, observer

    qsStringsDiff.deleted.forEach (qsString) =&gt;
        querySpec = J.fetching.parseQs qsString

        observer = session.observerByQsString().get qsString
        observer.stop()
        session.observerByQsString().<span class="hljs-keyword">delete</span> qsString</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Send updates to undo the effect that this cursor had on the client’s
view of the overall data set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        modelClass = J.models[querySpec.modelName]
        <span class="hljs-keyword">for</span> docId <span class="hljs-keyword">in</span> _.keys fieldsByModelIdQuery[querySpec.modelName] ? {}
            cursorValues = fieldsByModelIdQuery[querySpec.modelName][docId]

            changedFields = {}
            <span class="hljs-keyword">for</span> fieldName <span class="hljs-keyword">in</span> _.keys cursorValues
                valueByQsString = cursorValues[fieldName]
                oldValue = getField querySpec.modelName, docId, fieldName
                <span class="hljs-keyword">delete</span> valueByQsString[qsString]
                newValue = getField querySpec.modelName, docId, fieldName
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> EJSON.equals oldValue, newValue
                    changedFields[fieldName] = newValue
                <span class="hljs-keyword">if</span> _.isEmpty valueByQsString
                    <span class="hljs-keyword">delete</span> cursorValues[fieldName]

            <span class="hljs-keyword">if</span> _.isEmpty cursorValues
                <span class="hljs-keyword">delete</span> fieldsByModelIdQuery[querySpec.modelName][docId]</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>log querySpec, “sending REMOVED”, docId</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-property">@removed</span> modelClass.collection._name, docId
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isEmpty changedFields</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>log querySpec, “passing along CHANGED”, docId, changedFields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-property">@changed</span> modelClass.collection._name, docId, changedFields</pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="http://fuelyourcoding.com/scripts/toc/js/jquery.tableofcontents.min.js"></script>
  <script>
    $(function () {
      $("h1").first().after("<ul id='toc'>").after("<hr>");
      $("#toc").after("<hr>").tableOfContents(null, {
        startLevel: 2,
        depth: 10
      });
    });
  </script>
</body>
</html>

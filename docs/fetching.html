<!DOCTYPE html>

<html>
<head>
  <title>fetching.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="autodict.html">
                  autodict.coffee
                </a>
              
                
                <a class="source" href="autolist.html">
                  autolist.coffee
                </a>
              
                
                <a class="source" href="autovar.html">
                  autovar.coffee
                </a>
              
                
                <a class="source" href="components.html">
                  components.coffee
                </a>
              
                
                <a class="source" href="AreYouSure.html">
                  AreYouSure.coffee
                </a>
              
                
                <a class="source" href="Button.html">
                  Button.coffee
                </a>
              
                
                <a class="source" href="CancelButton.html">
                  CancelButton.coffee
                </a>
              
                
                <a class="source" href="DeleteButton.html">
                  DeleteButton.coffee
                </a>
              
                
                <a class="source" href="Dropdown.html">
                  Dropdown.coffee
                </a>
              
                
                <a class="source" href="EditButton.html">
                  EditButton.coffee
                </a>
              
                
                <a class="source" href="Expandable.html">
                  Expandable.coffee
                </a>
              
                
                <a class="source" href="KeyValueTable.html">
                  KeyValueTable.coffee
                </a>
              
                
                <a class="source" href="LinkButton.html">
                  LinkButton.coffee
                </a>
              
                
                <a class="source" href="Loader.html">
                  Loader.coffee
                </a>
              
                
                <a class="source" href="SubmitCancelDelete.html">
                  SubmitCancelDelete.coffee
                </a>
              
                
                <a class="source" href="TableRow.html">
                  TableRow.coffee
                </a>
              
                
                <a class="source" href="TextBox.html">
                  TextBox.coffee
                </a>
              
                
                <a class="source" href="denorm.html">
                  denorm.coffee
                </a>
              
                
                <a class="source" href="dict.html">
                  dict.coffee
                </a>
              
                
                <a class="source" href="dom.html">
                  dom.coffee
                </a>
              
                
                <a class="source" href="BooksDemo.html">
                  BooksDemo.coffee
                </a>
              
                
                <a class="source" href="SampleData.html">
                  SampleData.coffee
                </a>
              
                
                <a class="source" href="BatteryApi.html">
                  BatteryApi.coffee
                </a>
              
                
                <a class="source" href="ChatRoom.html">
                  ChatRoom.coffee
                </a>
              
                
                <a class="source" href="Home.html">
                  Home.coffee
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.coffee
                </a>
              
                
                <a class="source" href="NotFound.html">
                  NotFound.coffee
                </a>
              
                
                <a class="source" href="chat.html">
                  chat.coffee
                </a>
              
                
                <a class="source" href="routes.html">
                  routes.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="fetching.html">
                  fetching.coffee
                </a>
              
                
                <a class="source" href="j.html">
                  j.coffee
                </a>
              
                
                <a class="source" href="list.html">
                  list.coffee
                </a>
              
                
                <a class="source" href="models.html">
                  models.coffee
                </a>
              
                
                <a class="source" href="proptypes.html">
                  proptypes.coffee
                </a>
              
                
                <a class="source" href="publish.html">
                  publish.coffee
                </a>
              
                
                <a class="source" href="routing.html">
                  routing.coffee
                </a>
              
                
                <a class="source" href="autovar-tests.html">
                  autovar-tests.coffee
                </a>
              
                
                <a class="source" href="denorm-tests.html">
                  denorm-tests.coffee
                </a>
              
                
                <a class="source" href="dict-tests.html">
                  dict-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-client-tests.html">
                  jframework-client-tests.coffee
                </a>
              
                
                <a class="source" href="jframework-tests.html">
                  jframework-tests.coffee
                </a>
              
                
                <a class="source" href="list-tests.html">
                  list-tests.coffee
                </a>
              
                
                <a class="source" href="publish-tests.html">
                  publish-tests.coffee
                </a>
              
                
                <a class="source" href="test-models.html">
                  test-models.coffee
                </a>
              
                
                <a class="source" href="util-tests.html">
                  util-tests.coffee
                </a>
              
                
                <a class="source" href="tracker.html">
                  tracker.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="var.html">
                  var.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>fetching.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015, Quixey Inc.
All rights reserved.</p>
<p>Licensed under the Modified BSD License found in the
LICENSE file in the root directory of this source tree.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Projection semantics of querySpec.fields:
    “_” is a magic boolean key considered true by default.
    When true, the querySpec.fields object extends the
    model’s set of field and reactive inclusion defaults.
    When false, the querySpec.fields object represents the
    whole set of field inclusions being requested.</p>
<p>E.g. a model with these definitions…
    fields: # included by default
        a: {}
        b: include: false
        c: {}
    reactives: # not-included by default
        d: {}
        e: include: true</p>
<p>…would have this mapping from querySpec.fields to included fields:
    _: false
        []</p>
<pre><code>{} <span class="hljs-keyword">or</span> <span class="hljs-attribute">_</span>: <span class="hljs-literal">true</span>
    [<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>]

<span class="hljs-attribute">a</span>: <span class="hljs-literal">true</span>
    [<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>]

<span class="hljs-attribute">_</span>: <span class="hljs-literal">false</span>, <span class="hljs-attribute">a</span>: <span class="hljs-literal">true</span>
    [<span class="hljs-string">'a'</span>]

<span class="hljs-attribute">a</span>: <span class="hljs-literal">false</span>
    [<span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>]

<span class="hljs-attribute">b</span>: <span class="hljs-literal">true</span>
    [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>]

<span class="hljs-attribute">e</span>: <span class="hljs-literal">false</span>
    [<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>]

<span class="hljs-string">'a.x.y'</span>: <span class="hljs-literal">true</span>, <span class="hljs-attribute">c</span>: <span class="hljs-literal">false</span>
    [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a.x.y'</span>, <span class="hljs-string">'e'</span>]

<span class="hljs-attribute">_</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">'a.x.y'</span>: <span class="hljs-literal">true</span>, <span class="hljs-attribute">c</span>: <span class="hljs-literal">false</span>
    [<span class="hljs-string">'a.x.y'</span>]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>

J.fetching = {}

<span class="hljs-keyword">if</span> Meteor.isClient <span class="hljs-keyword">then</span> _.extend J.fetching,
    <span class="hljs-attribute">SESSION_ID</span>: <span class="hljs-string">"<span class="hljs-subst">#{parseInt Math.random() * <span class="hljs-number">1000000</span>}</span>"</span>

    <span class="hljs-attribute">_requestInProgress</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Latest client-side state and whether it’s changed since we
last called the server’s update method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">_requestersByQs</span>: {} <span class="hljs-comment"># querySpecString: {computationId: computation}</span>
    <span class="hljs-attribute">_requestsChanged</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Snapshot of what the cursors will be after the next _updateDataQueries returns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">_nextUnmergedQsSet</span>: {} <span class="hljs-comment"># querySpecString: true</span>
    <span class="hljs-attribute">_nextMergedQsSet</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Snapshot of what we last successfully asked the server for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">_unmergedQsSet</span>: {} <span class="hljs-comment"># mergedQuerySpecString: true</span>
    <span class="hljs-attribute">_mergedQsSet</span>: {} <span class="hljs-comment"># mergedQuerySpecString: true</span>

_.extend J.fetching,
    <span class="hljs-attribute">_deleteComputationQsRequests</span>: <span class="hljs-function"><span class="hljs-params">(computation)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> computation._requestingData
        <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> _.keys <span class="hljs-property">@_requestersByQs</span>
            <span class="hljs-keyword">delete</span> <span class="hljs-property">@_requestersByQs</span>[qsString][computation._id]
            <span class="hljs-keyword">if</span> _.isEmpty <span class="hljs-property">@_requestersByQs</span>[qsString]
                <span class="hljs-keyword">delete</span> <span class="hljs-property">@_requestersByQs</span>[qsString]
        computation._requestingData = <span class="hljs-literal">false</span>
        <span class="hljs-property">@_requestsChanged</span> = <span class="hljs-literal">true</span>
        Tracker.afterFlush (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@remergeQueries</span>()), Number.POSITIVE_INFINITY


    <span class="hljs-attribute">_getCanonical</span>: <span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Like EJSON.stringify but reorders object keys and
array elements to make “the same objects” yield
the same strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> _.isArray x
            J.util.sortByKey(
                <span class="hljs-property">@_getCanonical</span> y <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> x
                <span class="hljs-property">@_getCanonical</span>
            )
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> J.util.isPlainObject x
            sortedKeys = J.util.sortByKey _.keys x
            ret = {}
            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> sortedKeys
                ret[k] = <span class="hljs-property">@_getCanonical</span> x[k]
            ret
        <span class="hljs-keyword">else</span>
            x


    <span class="hljs-attribute">_projectionToInclusionSet</span>: <span class="hljs-function"><span class="hljs-params">(modelClass, projection)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>See the projection semantics documentation at the top of this file.</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Returns {includedFieldOrReactiveName: true}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        inclusionSet = {}

        <span class="hljs-keyword">if</span> projection._ <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>
            <span class="hljs-keyword">for</span> fieldOrReactiveName, include <span class="hljs-keyword">of</span> projection
                <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> fieldOrReactiveName <span class="hljs-keyword">is</span> <span class="hljs-string">'_'</span>
                <span class="hljs-keyword">if</span> include <span class="hljs-keyword">then</span> inclusionSet[fieldOrReactiveName] = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> fieldName, fieldSpec <span class="hljs-keyword">of</span> modelClass.fieldSpecs
                <span class="hljs-keyword">if</span> fieldSpec.include ? <span class="hljs-literal">true</span>
                    inclusionSet[fieldName] = <span class="hljs-literal">true</span>

            <span class="hljs-keyword">for</span> reactiveName, reactiveSpec <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
                <span class="hljs-keyword">if</span> reactiveSpec.include ? <span class="hljs-literal">false</span>
                    inclusionSet[reactiveName] = <span class="hljs-literal">true</span>

            <span class="hljs-keyword">for</span> fieldOrReactiveName, include <span class="hljs-keyword">of</span> projection
                <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> fieldOrReactiveName <span class="hljs-keyword">is</span> <span class="hljs-string">'_'</span>
                <span class="hljs-keyword">if</span> include
                    inclusionSet[fieldOrReactiveName] = <span class="hljs-literal">true</span>
                <span class="hljs-keyword">else</span>
                    <span class="hljs-keyword">delete</span> inclusionSet[fieldOrReactiveName]

        inclusionSet


    <span class="hljs-attribute">_qsToMongoOptions</span>: <span class="hljs-function"><span class="hljs-params">(qs)</span> -&gt;</span>
        modelClass = J.models[qs.modelName]
        options = {}
        options.fields = <span class="hljs-property">@projectionToMongoFieldsArg</span> modelClass, qs.fields ? {}
        <span class="hljs-keyword">for</span> optionName <span class="hljs-keyword">in</span> [<span class="hljs-string">'sort'</span>, <span class="hljs-string">'skip'</span>, <span class="hljs-string">'limit'</span>]
            <span class="hljs-keyword">if</span> qs[optionName]? <span class="hljs-keyword">then</span> options[optionName] = J.util.deepClone qs[optionName]
        options


    <span class="hljs-attribute">checkQuerySpec</span>: <span class="hljs-function"><span class="hljs-params">(querySpec)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Throws an error if the querySpec is invalid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        modelClass = J.models[querySpec.modelName]
        inclusionSet = <span class="hljs-property">@_projectionToInclusionSet</span> modelClass, querySpec.fields ? {}

        <span class="hljs-keyword">if</span> J.util.isPlainObject(querySpec.selector) <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> sKey, sValue <span class="hljs-keyword">of</span> querySpec.selector
            <span class="hljs-keyword">if</span> sKey <span class="hljs-keyword">isnt</span> <span class="hljs-string">'_id'</span> <span class="hljs-keyword">and</span> sKey[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'$'</span>
                ok = <span class="hljs-literal">false</span>
                <span class="hljs-keyword">for</span> fKey, fValue <span class="hljs-keyword">of</span> inclusionSet
                    <span class="hljs-keyword">if</span> fKey.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> sKey.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>]
                        ok = <span class="hljs-literal">true</span>
                        <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"
                        Missing projection for selector key <span class="hljs-subst">#{JSON.stringify sKey}</span>.
                        The projection must include/exclude every key in the selector
                        so that the fetch also works as expected on the client."</span>

        <span class="hljs-keyword">if</span> querySpec.sort? <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> sKey, sValue <span class="hljs-keyword">of</span> querySpec.sort
            <span class="hljs-keyword">if</span> sKey <span class="hljs-keyword">isnt</span> <span class="hljs-string">'_id'</span> <span class="hljs-keyword">and</span> sKey[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'$'</span>
                ok = <span class="hljs-literal">false</span>
                <span class="hljs-keyword">for</span> fKey, fValue <span class="hljs-keyword">of</span> inclusionSet
                    <span class="hljs-keyword">if</span> fKey.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> sKey.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>]
                        ok = <span class="hljs-literal">true</span>
                        <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"
                        Missing projection for sort key <span class="hljs-subst">#{JSON.stringify sKey}</span>.
                        The projection must include/exclude every key in the sort
                        so that the fetch also works as expected on the client."</span>


    <span class="hljs-attribute">getMerged</span>: <span class="hljs-function"><span class="hljs-params">(querySpecs)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>1.
    Merge all the querySpecs that select on _id using
    inclusionSetByModelInstance.
2.
    Attempt to pairwise merge all the querySpecs that
    don’t select on _id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        inclusionSetByModelInstance = {} <span class="hljs-comment"># modelName: id: fieldOrReactiveSpec: true</span>
        nonIdQuerySpecsByModel = {} <span class="hljs-comment"># modelName: [querySpecs] (will be pairwise merged)</span>
        mergedQuerySpecs = []
<span class="hljs-function">
        <span class="hljs-title">_getSelectorIds</span> = <span class="hljs-params">(qs)</span> =&gt;</span>
            qs = J.util.deepClone qs
            <span class="hljs-keyword">if</span> _.isString(qs.selector)
                qs.selector = <span class="hljs-attribute">_id</span>: qs.selector

            <span class="hljs-keyword">if</span> qs.selector._id?</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Note that if the selector has keys other than “_id” that may drop
the result count from 1 to 0, we’ll just ignore that and send a
dumber merged query to the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> _.isString qs.selector._id
                    [qs.selector._id]
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
                    _.isObject(qs.selector._id) <span class="hljs-keyword">and</span> _.size(qs.selector._id) <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span>
                    qs.selector._id.$<span class="hljs-keyword">in</span>? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> qs.limit? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> qs.skip
                )
                    qs.selector._id.$<span class="hljs-keyword">in</span>


        <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> querySpecs
            modelClass = J.models[qs.modelName]
            selectorIds = _getSelectorIds qs
            <span class="hljs-keyword">if</span> selectorIds?.length</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>(1) Merge this QS into inclusionSetByModelInstance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">for</span> selectorId <span class="hljs-keyword">in</span> selectorIds
                    existingIncludes = J.util.getField(
                        inclusionSetByModelInstance
                        [qs.modelName, <span class="hljs-string">'?.'</span>, selectorId]
                    ) ? J.util.setField(
                        inclusionSetByModelInstance
                        [qs.modelName, selectorId]
                        {}
                        <span class="hljs-literal">true</span>
                    )

                    inclusionSet = <span class="hljs-property">@_projectionToInclusionSet</span> modelClass, qs.fields ? {}
                    <span class="hljs-keyword">for</span> fieldSpec, include <span class="hljs-keyword">of</span> inclusionSet
                        existingIncludes[fieldSpec] = Boolean(
                            existingIncludes[fieldSpec] <span class="hljs-keyword">or</span> include
                        )

            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>(2) Add this to the list of non-ID-selecting querySpecs
to be pairwise merged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                nonIdQuerySpecsByModel[qs.modelName] ?= []
                nonIdQuerySpecsByModel[qs.modelName].push qs</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>(1) Dump inclusionSetByModelInstance into mergedQuerySpecs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> modelName, inclusionSetById <span class="hljs-keyword">of</span> inclusionSetByModelInstance
            idsByInclusionSetString = {} <span class="hljs-comment"># inclusionSetString: [instanceIds]</span>
            <span class="hljs-keyword">for</span> instanceId, inclusionSet <span class="hljs-keyword">of</span> inclusionSetById
                inclusionSetString = EJSON.stringify <span class="hljs-property">@_getCanonical</span> inclusionSet
                idsByInclusionSetString[inclusionSetString] ?= []
                idsByInclusionSetString[inclusionSetString].push instanceId

            <span class="hljs-keyword">for</span> inclusionSetString, instanceIds <span class="hljs-keyword">of</span> idsByInclusionSetString
                mergedProjection = _.extend(
                    <span class="hljs-attribute">_</span>: <span class="hljs-literal">false</span>
                    EJSON.parse inclusionSetString
                )
                mergedQuerySpecs.push
                    <span class="hljs-attribute">modelName</span>: modelName
                    <span class="hljs-attribute">selector</span>: <span class="hljs-attribute">_id</span>: <span class="hljs-attribute">$in</span>: instanceIds
                    <span class="hljs-attribute">fields</span>: mergedProjection</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>(2) Pairwise merge the nonIdQuerySpecs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> modelName, nonIdQuerySpecs <span class="hljs-keyword">of</span> nonIdQuerySpecsByModel
            qsStringSet = {} <span class="hljs-comment"># qsString: true</span>
            <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> nonIdQuerySpecs
                qsStringSet[J.fetching.stringifyQs qs] = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Iterate until no pair of qsStrings in qsStringSet
can be pairwise merged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>
                mergedSomething = <span class="hljs-literal">false</span>

                qsStrings = _.keys qsStringSet
                <span class="hljs-keyword">for</span> qsString, i <span class="hljs-keyword">in</span> qsStrings[qsStrings.length - <span class="hljs-number">1</span>]
                    <span class="hljs-keyword">for</span> qss <span class="hljs-keyword">in</span> qsStrings[i + <span class="hljs-number">1.</span>..]
                        pairwiseMergedQsString = <span class="hljs-property">@tryQsPairwiseMerge</span> qsString, qss
                        <span class="hljs-keyword">if</span> pairwiseMergedQsString?
                            <span class="hljs-keyword">delete</span> qsStringSet[qsString]
                            <span class="hljs-keyword">delete</span> qsStringSet[qss]
                            qsStringSet[pairwiseMergedQsString] = <span class="hljs-literal">true</span>
                            mergedSomething = <span class="hljs-literal">true</span>
                            <span class="hljs-keyword">break</span>

                    <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> mergedSomething

                <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mergedSomething</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Dump qsStringSet into mergedQuerySpecs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">of</span> qsStringSet
                mergedQuerySpecs.push J.fetching.parseQs qsString


        mergedQuerySpecs


    <span class="hljs-attribute">isQueryReady</span>: <span class="hljs-function"><span class="hljs-params">(qs)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>A query is considered ready if:
(1) It was bundled into the set of merged queries that the server
    has come back and said are ready.
(2) It has an _id selector, and all of the first-level doc values
    in its projection aren’t undefined.
    (Note that we can’t infer anything about first-level objects
    in the doc, because they may or may not be partial subdocs.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        qsString = J.fetching.stringifyQs qs
        modelClass = J.models[qs.modelName]

        qs = J.util.deepClone qs
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> J.util.isPlainObject qs.selector</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Note that this makes qs inconsistent with qsString</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            qs.selector = <span class="hljs-attribute">_id</span>: qs.selector
<span class="hljs-function">
        <span class="hljs-title">helper</span> = =&gt;</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> qsString <span class="hljs-keyword">of</span> <span class="hljs-property">@_unmergedQsSet</span> <span class="hljs-keyword">and</span> qsString <span class="hljs-keyword">of</span> <span class="hljs-property">@_nextUnmergedQsSet</span>

            <span class="hljs-keyword">if</span> _.isString(qs.selector._id) <span class="hljs-keyword">and</span> qs.selector._id <span class="hljs-keyword">of</span> modelClass.collection._attachedInstances</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>For queries with an _id filter, say it’s ready as long as minimongo
has an attached entry with that _id and no other parts of the selector
rule out the one possible match.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                options = <span class="hljs-property">@_qsToMongoOptions</span>(qs)
                options.transform = <span class="hljs-literal">false</span>
                options.reactive = <span class="hljs-literal">false</span>
                doc = modelClass.findOne(qs.selector, options)
                <span class="hljs-keyword">if</span> doc?
                    <span class="hljs-keyword">for</span> fieldSpec <span class="hljs-keyword">of</span> options.fields
                        fieldSpecParts = fieldSpec.split(<span class="hljs-string">'.'</span>)
                        <span class="hljs-keyword">if</span> fieldSpecParts[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'_id'</span>
                            <span class="hljs-keyword">continue</span>
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> fieldSpecParts[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'_reactives'</span>
                            reactiveName = fieldSpecParts[<span class="hljs-number">1</span>]?
                            value = doc._reactives[reactiveName]?.val
                        <span class="hljs-keyword">else</span>
                            fieldName = fieldSpecParts[<span class="hljs-number">0</span>]
                            value = doc[fieldName]

                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>This value might be ready, but there’s a risk that
it’s actually a partial subdoc, so we can only
trust it after qsString appears in @_unmergedQsSet.
FIXME:
It’s possible to do smarter bookkeeping to return true
when the full (sub)object being requested is already
on the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> J.util.isPlainObject value

                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

            <span class="hljs-literal">false</span>

        ret = helper()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>console.debug ‘isQueryReady’, ret, qsString</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ret


    <span class="hljs-attribute">parseQs</span>: <span class="hljs-function"><span class="hljs-params">(qsString)</span> -&gt;</span>
        EJSON.parse qsString


    <span class="hljs-attribute">projectionToMongoFieldsArg</span>: <span class="hljs-function"><span class="hljs-params">(modelClass, projection)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Input:
    The kind of projection passed to the “fields” argument when calling .fetch
    on a Model in JFramework.
Output:
    The corresponding Mongo-style fields-argument that we can pass to
    the second argument of MongoCollection.find.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        inclusionSet = <span class="hljs-property">@_projectionToInclusionSet</span> modelClass, projection

        mongoFieldsArg = {}

        <span class="hljs-keyword">for</span> includeSpec <span class="hljs-keyword">of</span> inclusionSet
            includeSpecParts = includeSpec.split(<span class="hljs-string">'.'</span>)
            fieldOrReactiveName = includeSpecParts[<span class="hljs-number">0</span>]

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (
                fieldOrReactiveName <span class="hljs-keyword">of</span> modelClass.fieldSpecs <span class="hljs-keyword">or</span>
                fieldOrReactiveName <span class="hljs-keyword">of</span> modelClass.reactiveSpecs
            )
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error <span class="hljs-string">"Invalid fieldOrReactiveName in
                    <span class="hljs-subst">#{modelClass.name}</span> inclusion set: <span class="hljs-subst">#{includeSpec}</span>"</span>

            <span class="hljs-keyword">if</span> fieldOrReactiveName <span class="hljs-keyword">of</span> modelClass.reactiveSpecs</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Convert someReactiveName.[etc] to _reactives.#{reactiveName}.val.[etc]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                reactiveFieldSpec =
                    [<span class="hljs-string">"_reactives.<span class="hljs-subst">#{fieldOrReactiveName}</span>.val"</span>].concat(includeSpecParts[<span class="hljs-number">1.</span>..]).join(<span class="hljs-string">'.'</span>)
                mongoFieldsArg[reactiveFieldSpec] = <span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>
                mongoFieldsArg[fieldOrReactiveName] = <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> _.isEmpty mongoFieldsArg
            mongoFieldsArg._id = <span class="hljs-number">1</span>

        mongoFieldsArg


    <span class="hljs-attribute">remergeQueries</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_requestInProgress</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@_requestsChanged</span>
        <span class="hljs-property">@_requestsChanged</span> = <span class="hljs-literal">false</span>

        newUnmergedQsStrings = _.keys <span class="hljs-property">@_requestersByQs</span>
        newUnmergedQuerySpecs = (J.fetching.parseQs qsString <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> newUnmergedQsStrings)
        <span class="hljs-property">@_nextUnmergedQsSet</span> = {}
        <span class="hljs-property">@_nextUnmergedQsSet</span>[qsString] = <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> newUnmergedQsStrings
        unmergedQsStringsDiff = J.util.diffStrings _.keys(<span class="hljs-property">@_unmergedQsSet</span>), _.keys(<span class="hljs-property">@_nextUnmergedQsSet</span>)

        newMergedQuerySpecs = <span class="hljs-property">@getMerged</span> newUnmergedQuerySpecs
        newMergedQsStrings = (J.fetching.stringifyQs querySpec <span class="hljs-keyword">for</span> querySpec <span class="hljs-keyword">in</span> newMergedQuerySpecs)
        <span class="hljs-property">@_nextMergedQsSet</span> = {}
        <span class="hljs-property">@_nextMergedQsSet</span>[qsString] = <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> newMergedQsStrings
        mergedQsStringsDiff = J.util.diffStrings _.keys(<span class="hljs-property">@_mergedQsSet</span>), _.keys(<span class="hljs-property">@_nextMergedQsSet</span>)

        addedQuerySpecs = (J.fetching.parseQs qsString <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> mergedQsStringsDiff.added)
        deletedQuerySpecs = (J.fetching.parseQs qsString <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> mergedQsStringsDiff.deleted)
<span class="hljs-function">
        <span class="hljs-title">doAfterUpdatingUnmergedQsSet</span> = =&gt;</span>
            <span class="hljs-keyword">for</span> addedUnmergedQsString <span class="hljs-keyword">in</span> unmergedQsStringsDiff.added
                <span class="hljs-keyword">for</span> computationId <span class="hljs-keyword">in</span> _.keys <span class="hljs-property">@_requestersByQs</span>[addedUnmergedQsString] ? {}
                    <span class="hljs-property">@_requestersByQs</span>[addedUnmergedQsString][computationId].invalidate()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>There may be changes to @_requestersByQs that we couldn’t act on
until this request was done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Tracker.afterFlush (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@remergeQueries</span>()), Number.POSITIVE_INFINITY

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (addedQuerySpecs.length <span class="hljs-keyword">or</span> deletedQuerySpecs.length)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>The merged query set hasn’t changed so we don’t need to hit the server,
but it’s important to update @_unmergedQsSet as if we had.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@_unmergedQsSet</span> = _.clone <span class="hljs-property">@_nextUnmergedQsSet</span>
            doAfterUpdatingUnmergedQsSet()
            <span class="hljs-keyword">return</span>


        debug = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> debug
<span class="hljs-function">            <span class="hljs-title">consolify</span> = <span class="hljs-params">(querySpec)</span> -&gt;</span>
                obj = _.clone querySpec
                <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-string">'selector'</span>, <span class="hljs-string">'fields'</span>, <span class="hljs-string">'sort'</span>]
                    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">of</span> obj <span class="hljs-keyword">then</span> obj[x] = J.util.stringify obj[x]
                obj

            <span class="hljs-keyword">if</span> deletedQuerySpecs.length
                <span class="hljs-built_in">console</span>.groupCollapsed <span class="hljs-string">"-"</span>
                <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"    "</span>, consolify(qs) <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> deletedQuerySpecs
                <span class="hljs-built_in">console</span>.groupEnd()
            <span class="hljs-keyword">if</span> addedQuerySpecs.length
                <span class="hljs-built_in">console</span>.groupCollapsed <span class="hljs-string">"+"</span>
                <span class="hljs-keyword">for</span> qsString <span class="hljs-keyword">in</span> unmergedQsStringsDiff.added
                    <span class="hljs-keyword">for</span> computationId, computation <span class="hljs-keyword">of</span> <span class="hljs-property">@_requestersByQs</span>[qsString]
                        <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">console</span>.log computation
                <span class="hljs-built_in">console</span>.debug <span class="hljs-string">"    "</span>, consolify(qs) <span class="hljs-keyword">for</span> qs <span class="hljs-keyword">in</span> addedQuerySpecs
                <span class="hljs-built_in">console</span>.groupEnd()

        <span class="hljs-property">@_requestInProgress</span> = <span class="hljs-literal">true</span>
        Meteor.call <span class="hljs-string">'_updateDataQueries'</span>,
            <span class="hljs-property">@SESSION_ID</span>,
            addedQuerySpecs,
            deletedQuerySpecs,
            <span class="hljs-function"><span class="hljs-params">(error, result)</span> =&gt;</span>
                <span class="hljs-property">@_requestInProgress</span> = <span class="hljs-literal">false</span>
                <span class="hljs-keyword">if</span> error
                    <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Fetching error:"</span>, error
                    <span class="hljs-keyword">return</span>

                <span class="hljs-property">@_unmergedQsSet</span> = _.clone <span class="hljs-property">@_nextUnmergedQsSet</span>
                <span class="hljs-property">@_mergedQsSet</span> = _.clone <span class="hljs-property">@_nextMergedQsSet</span>

                doAfterUpdatingUnmergedQsSet()


    <span class="hljs-attribute">requestQuery</span>: <span class="hljs-function"><span class="hljs-params">(querySpec)</span> -&gt;</span>
        J.assert Tracker.active

        <span class="hljs-property">@checkQuerySpec</span> querySpec

        qsString = J.fetching.stringifyQs querySpec
        computation = Tracker.currentComputation

        <span class="hljs-property">@_requestersByQs</span>[qsString] ?= {}
        <span class="hljs-keyword">if</span> computation._id <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> <span class="hljs-property">@_requestersByQs</span>[qsString]
            <span class="hljs-property">@_requestersByQs</span>[qsString][computation._id] = computation
            computation._requestingData = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Note: AutoVar handles logic to remove from @_requestersByQueue
because it involves complicated sequencing with React component
rendering.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@_requestsChanged</span> = <span class="hljs-literal">true</span>
            Tracker.afterFlush (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@remergeQueries</span>()), Number.POSITIVE_INFINITY

        <span class="hljs-keyword">if</span> <span class="hljs-property">@isQueryReady</span> querySpec
            modelClass = J.models[querySpec.modelName]
            options = <span class="hljs-property">@_qsToMongoOptions</span> querySpec

            <span class="hljs-keyword">if</span> Tracker.active
                results = J.List Tracker.nonreactive -&gt;
                    modelClass.find(querySpec.selector, options).fetch()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The individual model instances’ getters have their own reactivity, so
this query should only invalidate if a result gets added/removed/moved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                idQueryOptions = _.clone options
                idQueryOptions.fields = <span class="hljs-attribute">_id</span>: <span class="hljs-number">1</span>
                idQueryOptions.transform = <span class="hljs-literal">null</span>

                initializing = <span class="hljs-literal">true</span>
<span class="hljs-function">                <span class="hljs-title">invalidator</span> = -&gt;</span> computation.invalidate() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> initializing
                modelClass.find(querySpec.selector, idQueryOptions).observe
                    <span class="hljs-attribute">added</span>: invalidator
                    <span class="hljs-attribute">movedTo</span>: invalidator
                    <span class="hljs-attribute">removed</span>: invalidator
                initializing = <span class="hljs-literal">false</span>

                results

            <span class="hljs-keyword">else</span>
                J.List modelClass.find(querySpec.selector, options).fetch()

        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> J.makeValueNotReadyObject()


    <span class="hljs-attribute">stringifyQs</span>: <span class="hljs-function"><span class="hljs-params">(qs)</span> -&gt;</span>
        EJSON.stringify
            <span class="hljs-attribute">modelName</span>: qs.modelName
            <span class="hljs-attribute">selector</span>: <span class="hljs-property">@_getCanonical</span> qs.selector
            <span class="hljs-attribute">fields</span>: <span class="hljs-property">@_getCanonical</span> qs.fields
            <span class="hljs-attribute">sort</span>: <span class="hljs-property">@_getCanonical</span> qs.sort
            <span class="hljs-attribute">limit</span>: qs.limit
            <span class="hljs-attribute">skip</span>: qs.skip


    <span class="hljs-attribute">tryQsPairwiseMerge</span>: <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> a.modelName <span class="hljs-keyword">isnt</span> b.modelName

        <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="http://fuelyourcoding.com/scripts/toc/js/jquery.tableofcontents.min.js"></script>
  <script>
    $(function () {
      $("h1").first().after("<ul id='toc'>").after("<hr>");
      $("#toc").after("<hr>").tableOfContents(null, {
        startLevel: 2,
        depth: 10
      });
    });
  </script>
</body>
</html>
